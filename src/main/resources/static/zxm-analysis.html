<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è´¢åŠ¡åˆ†æç³»ç»Ÿ - å¼ æ–°æ°‘ç»“æ„æ€§è´¢åŠ¡åˆ†æ</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ç¡®ä¿ECharts tooltipå§‹ç»ˆåœ¨æœ€é¡¶å±‚ */
        .echarts-tooltip {
            z-index: 9999 !important;
        }

        /* å…¨å±€tooltipæ ·å¼ */
        [data-echarts-tooltip] {
            z-index: 9999 !important;
            position: absolute !important;
        }

        /* ç¡®ä¿æ‰€æœ‰EChartsç›¸å…³å…ƒç´ éƒ½åœ¨æœ€é¡¶å±‚ */
        .echarts-tooltip,
        .echarts-tooltip *,
        [class*="echarts"],
        [id*="echarts"] {
            z-index: 9999 !important;
        }

        /* ç‰¹åˆ«å¤„ç†tooltipå®¹å™¨ */
        .echarts-tooltip {
            position: absolute !important;
            z-index: 9999 !important;
            pointer-events: auto !important;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            color: #1a202c;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            overflow: hidden;
            margin-top: 12px;
            margin-bottom: 20px;
        }

        .header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }

        .header .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            z-index: 1;
        }

        .header .logo {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: logoGlow 3s ease-in-out infinite;
        }

        .header .logo-icon {
            font-size: 20px;
            color: white;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        @keyframes logoGlow {

            0%,
            100% {
                box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
            }

            50% {
                box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            }
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.025em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin: 0;
        }

        .header .nav-section {
            display: flex;
            align-items: center;
            gap: 16px;
            position: relative;
            z-index: 1;
        }

        .nav-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .nav-button:active {
            transform: translateY(0);
        }

        .nav-button .nav-icon {
            font-size: 16px;
        }

        /* è‡ªé€‰è‚¡è¡¨æ ¼æ ·å¼ */
        .watchlist-section {
            display: none;
            padding: 24px;
            background: #ffffff;
            border-bottom: 1px solid #e2e8f0;
        }

        .watchlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .watchlist-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1a202c;
        }

        .watchlist-close {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        .watchlist-close:hover {
            background: #dc2626;
        }

        .watchlist-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .watchlist-table th,
        .watchlist-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .watchlist-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .watchlist-table tr:hover {
            background: #f9fafb;
        }

        .watchlist-table tr:last-child td {
            border-bottom: none;
        }

        .stock-type-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            text-align: center;
            min-width: 60px;
        }

        .stock-type-0 {
            background: #f3f4f6;
            color: #6b7280;
        }

        .stock-type-1 {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .stock-type-2 {
            background: #dcfce7;
            color: #166534;
        }

        .analyze-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }

        .analyze-btn:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }

        .analyze-btn:active {
            transform: translateY(0);
        }





        .input-section {
            padding: 24px 24px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .input-group {
            display: flex;
            gap: 12px;
            justify-content: center;
            align-items: center;
            max-width: 900px;
            margin: 0 auto;
        }

        .switch-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            justify-content: center;
        }

        .switch-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
            white-space: nowrap;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
            flex-shrink: 0;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #10b981;
            transition: .3s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #3b82f6;
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        .input-wrapper {
            position: relative;
            flex: 1;
            min-width: 0;
        }

        .input-group input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            color: #374151;
            box-sizing: border-box;
        }

        .input-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .input-group input::placeholder {
            color: #9ca3af;
        }

        .stock-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #ffffff;
            border: 2px solid #3b82f6;
            border-top: none;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
        }

        .suggestion-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover {
            background-color: #f8fafc;
        }

        .suggestion-item.selected {
            background-color: #eff6ff;
        }

        .suggestion-code {
            font-weight: 600;
            color: #1f2937;
        }

        .suggestion-name {
            color: #6b7280;
            font-size: 14px;
        }

        .suggestion-type {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            color: #ffffff;
        }

        .suggestion-type.ashare {
            background-color: #3b82f6;
        }

        .suggestion-type.hk {
            background-color: #10b981;
        }

        .input-group button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }

        .input-group button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .input-group button:hover::before {
            left: 100%;
        }

        .input-group button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .input-group button:active {
            transform: translateY(0);
        }

        .input-group button:disabled {
            background: #9ca3af;
            transform: none;
            box-shadow: none;
            cursor: not-allowed;
        }

        #flipStoneBtn {
            background: linear-gradient(135deg, #7c3aed 0%, #8b5cf6 100%);
        }

        #flipStoneBtn:hover {
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);
        }



        .loading {
            text-align: center;
            padding: 48px 32px;
            color: #6b7280;
            font-size: 16px;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 28px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            min-width: 480px;
            max-width: 580px;
            box-shadow:
                0 25px 50px -12px rgba(0, 0, 0, 0.15),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            overflow: hidden;
            backdrop-filter: blur(20px);
            animation: fadeInScale 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .loading::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                left: -100%;
            }

            100% {
                left: 100%;
            }
        }

        .loading .loading-spinner {
            position: relative;
            width: 72px;
            height: 72px;
        }

        .loading .loading-spinner::before,
        .loading .loading-spinner::after {
            content: '';
            position: absolute;
            border-radius: 50%;
        }

        .loading .loading-spinner::before {
            width: 72px;
            height: 72px;
            border: 3px solid #f1f5f9;
            box-shadow: inset 0 0 16px rgba(0, 0, 0, 0.05);
        }

        .loading .loading-spinner::after {
            width: 72px;
            height: 72px;
            border: 3px solid transparent;
            border-top-color: #3b82f6;
            border-right-color: #3b82f6;
            animation: spin 1.4s cubic-bezier(0.4, 0, 0.2, 1) infinite;
            box-shadow: 0 0 24px rgba(59, 130, 246, 0.2);
        }

        .loading .loading-text {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.8;
            }
        }

        .loading .loading-subtext {
            font-size: 14px;
            color: #6b7280;
            opacity: 0.9;
            max-width: 400px;
            line-height: 1.5;
        }



        .loading .loading-dots {
            display: flex;
            gap: 6px;
            margin-top: 12px;
        }

        .loading .loading-dots span {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            animation: dots 1.4s ease-in-out infinite both;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .loading .loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading .loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        .loading .loading-dots span:nth-child(3) {
            animation-delay: 0s;
        }

        .loading .loading-steps {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 16px;
            max-width: 300px;
        }

        .loading .loading-step {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #6b7280;
            opacity: 0.7;
            animation: fadeInUp 0.5s ease-out;
        }

        .loading .loading-step.active {
            color: #3b82f6;
            opacity: 1;
            font-weight: 500;
        }

        .loading .loading-step-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            color: #6b7280;
        }

        .loading .loading-step.active .loading-step-icon {
            background: #3b82f6;
            color: white;
            animation: checkmark 0.3s ease-out;
        }

        @keyframes checkmark {
            0% {
                transform: scale(0);
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes dots {

            0%,
            80%,
            100% {
                transform: scale(0);
                opacity: 0.5;
            }

            40% {
                transform: scale(1);
                opacity: 1;
            }
        }



        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .input-tips {
            margin-top: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .tip-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(59, 130, 246, 0.05);
            border-radius: 6px;
            border-left: 3px solid #3b82f6;
        }

        .tip-icon {
            font-size: 16px;
            flex-shrink: 0;
        }

        .tip-text {
            font-size: 13px;
            color: #4b5563;
            line-height: 1.4;
        }

        .error {
            text-align: center;
            color: #dc2626;
            padding: 16px 20px;
            background: #fef2f2;
            border-radius: 8px;
            margin: 24px;
            border-left: 3px solid #dc2626;
            font-size: 14px;
            font-weight: 500;
        }

        .chart-container {
            padding: 24px;
        }

        .chart-row {
            display: flex;
            gap: 24px;
            margin-bottom: 32px;
        }

        .chart-row .chart-wrapper {
            flex: 1;
            min-width: 0;
        }

        @media (max-width: 1200px) {
            .chart-row {
                flex-direction: column;
                gap: 24px;
            }
        }

        .chart {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .chart:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* å“åº”å¼å¸ƒå±€ */
        @media (max-width: 1200px) {
            .chart-container .flex-row {
                flex-direction: column;
            }

            .chart-container .flex-row>div {
                margin-bottom: 20px;
            }
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 8px;
            }

            .header {
                padding: 24px 16px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .header p {
                font-size: 0.875rem;
            }

            .input-section {
                padding: 24px 16px;
            }

            .input-group {
                flex-direction: column;
                gap: 12px;
            }

            .chart {
                height: 300px;
            }

            .hero-title {
                font-size: 1.5rem;
            }

            .hero-subtitle {
                font-size: 0.875rem;
            }

            .stats-section {
                flex-direction: column;
                gap: 16px;
            }

            .tech-highlights {
                flex-direction: column;
                gap: 8px;
            }

            .stat-number {
                font-size: 1.5rem;
            }

            .welcome-section {
                padding: 32px 16px;
            }
        }

        /* æ¬¢è¿åŒºåŸŸ */
        .welcome-section {
            padding: 48px 24px;
            text-align: center;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            position: relative;
            overflow: hidden;
        }

        .welcome-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="dots" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="1" fill="%23e2e8f0"/></pattern></defs><rect width="100" height="100" fill="url(%23dots)"/></svg>');
            opacity: 0.5;
        }

        .welcome-content {
            position: relative;
            z-index: 1;
        }

        .hero-section {
            text-align: center;
            margin-bottom: 32px;
        }

        .hero-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            display: block;
            color: #3b82f6;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .hero-title {
            font-size: 2rem;
            color: #1e293b;
            margin-bottom: 12px;
            font-weight: 600;
            letter-spacing: -0.025em;
        }

        .hero-subtitle {
            font-size: 1rem;
            color: #64748b;
            margin-bottom: 32px;
            line-height: 1.5;
            font-weight: 400;
        }

        .stats-section {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-bottom: 32px;
            animation: fadeInUp 0.6s ease-out 0.2s both;
        }

        .stat-item {
            text-align: center;
            padding: 16px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #64748b;
            font-weight: 500;
        }

        .tech-highlights {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-bottom: 24px;
            animation: fadeInUp 0.6s ease-out 0.4s both;
        }

        .highlight-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .highlight-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.1);
        }

        .highlight-icon {
            font-size: 1rem;
            color: #3b82f6;
        }

        .highlight-text {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .chart-container {
            animation: slideIn 0.6s ease-out;
        }

        .chart {
            animation: fadeInUp 0.8s ease-out;
        }

        /* è‚¡ç¥¨ä¿¡æ¯å±•ç¤ºåŒºåŸŸæ ·å¼ */
        .stock-info-section {
            padding: 24px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-bottom: 1px solid #e2e8f0;
            animation: slideIn 0.6s ease-out;
        }

        .stock-info-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .stock-info-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .stock-info-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }

        .stock-info-header h2 {
            font-size: 1.4rem;
            font-weight: 600;
            color: #1e40af;
            margin: 0;
        }

        .stock-actions {
            display: flex;
            gap: 12px;
            position: absolute;
            right: 0;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .action-btn:active {
            transform: translateY(0);
        }

        .watch-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            color: white;
        }

        .watch-btn:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1e3a8a 100%);
        }

        .portfolio-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .portfolio-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .delete-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .delete-btn:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }

        .watch-badge {
            display: inline-block;
            background: #3b82f6;
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: 600;
        }

        .portfolio-badge {
            display: inline-block;
            background: #10b981;
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: 600;
        }



        .stock-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            max-width: 1000px;
            margin: 0 auto;
        }

        .stock-info-item {
            background: white;
            padding: 12px 16px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 60px;
        }

        .stock-info-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
            border-color: #3b82f6;
        }

        .info-label {
            font-size: 0.8rem;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 3px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 1rem;
            color: #1f2937;
            font-weight: 600;
            line-height: 1.2;
        }

        .info-value.highlight {
            color: #059669;
        }

        .info-value.warning {
            color: #dc2626;
        }

        /* ä¸åŒä¿¡æ¯ç»„çš„è§†è§‰åŒºåˆ† */
        .stock-info-item.basic-info {
            border-left: 3px solid #3b82f6;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .stock-info-item.shares-info {
            border-left: 3px solid #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
        }

        .stock-info-item.market-info {
            border-left: 3px solid #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }

        .stock-info-item.other-info {
            border-left: 3px solid #8b5cf6;
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        }

        /* å…¨å®½ä¿¡æ¯é¡¹æ ·å¼ */
        .stock-info-item.full-width {
            grid-column: 1 / -1;
            padding: 16px 20px;
        }

        .stock-info-item.full-width .info-label {
            margin-bottom: 6px;
        }

        .stock-info-item.full-width .info-value {
            margin-bottom: 12px;
        }

        .stock-info-item.full-width .info-value:last-child {
            margin-bottom: 0;
        }

        /* å…¬å¸ç®€ä»‹éƒ¨åˆ†æ ·å¼ */
        .company-intro-section {
            margin-top: 24px;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }

        .company-intro-header {
            margin-bottom: 16px;
            text-align: center;
        }

        .company-intro-header h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1e40af;
            margin: 0;
            padding: 12px 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }

        .company-intro-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            line-height: 1.6;
            color: #374151;
            font-size: 0.95rem;
            text-align: justify;
        }

        /* å“åº”å¼ä¼˜åŒ– */
        @media (max-width: 768px) {
            .stock-info-grid {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
                gap: 8px;
            }
            
            .stock-info-item {
                padding: 10px 12px;
                min-height: 50px;
            }
            
            .stock-info-item.full-width {
                padding: 14px 16px;
            }
            
            .info-label {
                font-size: 0.75rem;
            }
            
            .info-value {
                font-size: 0.9rem;
            }
            
            .company-intro-section {
                margin-top: 20px;
            }
            
            .company-intro-header h3 {
                font-size: 1.1rem;
                padding: 10px 16px;
            }
            
            .company-intro-content {
                padding: 16px;
                font-size: 0.9rem;
            }
        }





        .footer {
            text-align: center;
            padding: 16px 24px;
            color: #6b7280;
            font-size: 0.875rem;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="logo-section">
                <div class="logo">
                    <span class="logo-icon">ğŸ“Š</span>
                </div>
                <h1>æ™ºèƒ½è´¢åŠ¡åˆ†æç³»ç»Ÿ</h1>
            </div>
            <div class="nav-section">
                <button class="nav-button" onclick="showWatchlist()">
                    <span class="nav-icon">â­</span>
                    è‡ªé€‰è‚¡
                </button>
            </div>
        </div>

        <div class="input-section">
            <div class="input-group">
                <div class="switch-wrapper">
                    <span class="switch-label">æŒ‰æŠ¥å‘ŠæœŸ</span>
                    <label class="switch">
                        <input type="checkbox" id="analysisSwitch">
                        <span class="slider"></span>
                    </label>
                    <span class="switch-label">æŒ‰å¹´åº¦</span>
                </div>
                <div class="input-wrapper">
                    <input type="text" id="stockSymbol" placeholder="è¯·è¾“å…¥è‚¡ç¥¨ä»£ç æˆ–åç§°æœç´¢ï¼ˆAè‚¡6ä½ï¼š000001ï¼Œæ¸¯è‚¡5ä½ï¼š00700ï¼‰"
                        maxlength="10">
                    <div id="stockSuggestions" class="stock-suggestions" style="display: none;"></div>
                </div>
                <button onclick="analyzeStock()" id="analyzeBtn">å¼€å§‹åˆ†æ</button>
                <button onclick="flipStone()" id="flipStoneBtn">ç¿»å—çŸ³å¤´</button>
            </div>

        </div>

        <!-- è‡ªé€‰è‚¡è¡¨æ ¼åŒºåŸŸ -->
        <div id="watchlistSection" class="watchlist-section">
            <div class="watchlist-header">
                <h2 class="watchlist-title">è‡ªé€‰è‚¡åˆ—è¡¨</h2>
                <button class="watchlist-close" onclick="hideWatchlist()">å…³é—­</button>
            </div>
            <div id="watchlistTableContainer">
                <table class="watchlist-table">
                    <thead>
                        <tr>
                            <th>è‚¡ç¥¨ä»£ç </th>
                            <th>è‚¡ç¥¨åç§°</th>
                            <th>ç±»å‹</th>
                            <th>å¸‚ç›ˆç‡TTM</th>
                            <th>ROE(%)</th>
                            <th>åˆ©æ¶¦è´¨é‡</th>
                            <th>èµ„äº§è´¨é‡å¾—åˆ†</th>
                            <th>å¸‚ç›ˆç‡å¾—åˆ†</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="watchlistTableBody">
                        <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- æ¬¢è¿åŒºåŸŸ -->
        <div id="welcomeSection" class="welcome-section">
            <div class="welcome-content">
                <div class="hero-section">
                    <div class="hero-icon">ğŸ“Š</div>
                    <h1 class="hero-title">æ™ºèƒ½è´¢åŠ¡åˆ†æç³»ç»Ÿ</h1>
                    <p class="hero-subtitle">åŸºäºå¼ æ–°æ°‘æ•™æˆç»“æ„æ€§è´¢åŠ¡åˆ†æç†è®ºï¼Œå…¨é¢åˆ†æAè‚¡å’Œæ¸¯è‚¡ä¸Šå¸‚å…¬å¸è´¢åŠ¡çŠ¶å†µï¼Œæä¾›ROEã€PEã€èµ„äº§è´Ÿå€ºç»“æ„ã€ç›ˆåˆ©èƒ½åŠ›ç­‰å¤šç»´åº¦åˆ†æ</p>
                </div>

                <div class="stats-section">
                    <div class="stat-item">
                        <div class="stat-number">2</div>
                        <div class="stat-label">å¸‚åœºè¦†ç›–</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">96</div>
                        <div class="stat-label">è´¢åŠ¡æŒ‡æ ‡</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">5</div>
                        <div class="stat-label">åˆ†æç»´åº¦</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">âˆ</div>
                        <div class="stat-label">æ•°æ®æ´å¯Ÿ</div>
                    </div>
                </div>

                <div class="tech-highlights">
                    <div class="highlight-item">
                        <span class="highlight-icon">ğŸ“ˆ</span>
                        <span class="highlight-text">Aè‚¡æ¸¯è‚¡</span>
                    </div>
                    <div class="highlight-item">
                        <span class="highlight-icon">ğŸ“Š</span>
                        <span class="highlight-text">ç»“æ„æ€§åˆ†æ</span>
                    </div>
                    <div class="highlight-item">
                        <span class="highlight-icon">ğŸ“‹</span>
                        <span class="highlight-text">å¯è§†åŒ–å›¾è¡¨</span>
                    </div>
                    <div class="highlight-item">
                        <span class="highlight-icon">ğŸ”</span>
                        <span class="highlight-text">å¤šç»´åº¦æŒ‡æ ‡</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="loadingOverlay"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999;">
        </div>
        <div id="loading" class="loading" style="display: none;">
            <div class="loading-spinner"></div>
            <div class="loading-text">æ­£åœ¨åˆ†ææ•°æ®</div>
            <div class="loading-subtext">è¯·ç¨å€™ï¼Œç³»ç»Ÿæ­£åœ¨è·å–è´¢åŠ¡æ•°æ®å¹¶ç”Ÿæˆåˆ†ææŠ¥å‘Š</div>
            <div class="loading-steps">
                <div class="loading-step" id="step1">
                    <div class="loading-step-icon">1</div>
                    <span>è¿æ¥æ•°æ®æº</span>
                </div>
                <div class="loading-step" id="step2">
                    <div class="loading-step-icon">2</div>
                    <span>è·å–è´¢åŠ¡æ•°æ®</span>
                </div>
                <div class="loading-step" id="step3">
                    <div class="loading-step-icon">3</div>
                    <span>è®¡ç®—åˆ†ææŒ‡æ ‡</span>
                </div>
                <div class="loading-step" id="step4">
                    <div class="loading-step-icon">4</div>
                    <span>ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨</span>
                </div>
            </div>
            <div class="loading-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <!-- è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯å±•ç¤ºåŒºåŸŸ -->
        <div id="stockInfoSection" class="stock-info-section" style="display: none;">
            <div class="stock-info-content">
                <div class="stock-info-header">
                    <h2 id="stockInfoTitle">è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯</h2>
                    <div class="stock-actions">
                        <button id="addToWatchlistBtn" class="action-btn watch-btn" onclick="addToWatchlist(1)">
                            åŠ è§‚å¯Ÿ
                        </button>
                        <button id="addToPortfolioBtn" class="action-btn portfolio-btn" onclick="addToWatchlist(2)">
                            è®¾ä¸ºæŒä»“è‚¡
                        </button>
                    </div>
                </div>
                <div class="stock-info-grid">
                    <!-- åŸºæœ¬ä¿¡æ¯ç»„ -->
                    <div class="stock-info-item basic-info">
                        <div class="info-label">è‚¡ç¥¨ä»£ç </div>
                        <div class="info-value" id="stockCode">-</div>
                    </div>
                    <div class="stock-info-item basic-info">
                        <div class="info-label">è‚¡ç¥¨åç§°</div>
                        <div class="info-value" id="stockName">-</div>
                    </div>
                    <div class="stock-info-item basic-info">
                        <div class="info-label">æœ€æ–°ä»·æ ¼</div>
                        <div class="info-value" id="stockPrice">-</div>
                    </div>
                    <div class="stock-info-item basic-info">
                        <div class="info-label">æ‰€å±è¡Œä¸š</div>
                        <div class="info-value" id="stockIndustry">-</div>
                    </div>
                    
                    <!-- è‚¡æœ¬ä¿¡æ¯ç»„ -->
                    <div class="stock-info-item shares-info">
                        <div class="info-label">æ€»è‚¡æœ¬</div>
                        <div class="info-value" id="stockTotalShares">-</div>
                    </div>
                    <div class="stock-info-item shares-info">
                        <div class="info-label">æµé€šè‚¡</div>
                        <div class="info-value" id="stockCirculatingShares">-</div>
                    </div>
                    
                    <!-- å¸‚å€¼ä¿¡æ¯ç»„ -->
                    <div class="stock-info-item market-info">
                        <div class="info-label">æ€»å¸‚å€¼</div>
                        <div class="info-value" id="stockTotalMarketValue">-</div>
                    </div>
                    <div class="stock-info-item market-info">
                        <div class="info-label">æµé€šå¸‚å€¼</div>
                        <div class="info-value" id="stockCirculatingMarketValue">-</div>
                    </div>
                    
                    <!-- å…¶ä»–ä¿¡æ¯ç»„ -->
                    <div class="stock-info-item other-info">
                        <div class="info-label">ä¸Šå¸‚æ—¶é—´</div>
                        <div class="info-value" id="stockListingDate">-</div>
                    </div>
                    <div class="stock-info-item other-info">
                        <div class="info-label">ROE</div>
                        <div class="info-value" id="stockRoe">-</div>
                    </div>
                    <div class="stock-info-item other-info">
                        <div class="info-label">å¸‚ç›ˆç‡</div>
                        <div class="info-value" id="stockPe">-</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="chartContainer" class="chart-container" style="display: none;">
            <div id="analysisChart" class="chart"></div>
        </div>

        <div class="footer">
            <p>å¼ æ–°æ°‘ç»“æ„æ€§è´¢åŠ¡åˆ†æç³»ç»Ÿ | åŸºäºå¼ æ–°æ°‘æ•™æˆè´¢åŠ¡åˆ†æç†è®º</p>
        </div>
    </div>

    <script>

        function flipStone() {
            // éšè—æœç´¢å»ºè®®æ¡†
            hideSuggestions();

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loadingOverlay').style.display = 'block';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('chartContainer').style.display = 'none';
            document.getElementById('stockInfoSection').style.display = 'none';
            document.getElementById('welcomeSection').style.display = 'none';
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('flipStoneBtn').disabled = true;

            // é‡ç½®åŠ è½½æ­¥éª¤
            resetLoadingSteps();

            // å¼€å§‹ç¿»çŸ³å¤´ä¸“ç”¨åŠ¨ç”»
            startFlipStoneAnimation();

            // è·å–è‚¡ç¥¨åˆ—è¡¨
            Promise.all([
                fetch('http://localhost:8888/api/zxm/stock-list'),
                fetch('http://localhost:8888/api/zxm/hk-stock-list')
            ])
                .then(responses => {
                    return Promise.all(responses.map(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    }));
                })
                .then(([aShareData, hkData]) => {
                    if (!aShareData || aShareData.length === 0) {
                        throw new Error('è·å–Aè‚¡åˆ—è¡¨å¤±è´¥');
                    }

                    // è¿‡æ»¤å‡ºAè‚¡è‚¡ç¥¨ï¼ˆ6ä½æ•°å­—ä»£ç ï¼‰
                    const aShareStocks = aShareData.filter(stock => stock.code && stock.code.length === 6 && /^\d{6}$/.test(stock.code));

                    if (aShareStocks.length === 0) {
                        throw new Error('æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„Aè‚¡è‚¡ç¥¨');
                    }

                    // æš‚æ—¶åªä»Aè‚¡ä¸­éšæœºé€‰æ‹©
                    const randomIndex = Math.floor(Math.random() * aShareStocks.length);
                    const selectedStock = aShareStocks[randomIndex];

                    console.log('ç¿»çŸ³å¤´æ‰¾åˆ°çš„å®è—è‚¡ç¥¨:', selectedStock);

                    // æ›´æ–°è¾“å…¥æ¡†
                    document.getElementById('stockSymbol').value = selectedStock.code;

                    // ç›´æ¥æ‰§è¡Œåˆ†æï¼Œä½¿ç”¨å¼€å§‹åˆ†ææ—¶çš„åŠ¨ç”»
                    analyzeStock();
                })
                .catch(error => {
                    completeLoading();
                    document.getElementById('analyzeBtn').disabled = false;
                    document.getElementById('flipStoneBtn').disabled = false;
                    showError('ç¿»çŸ³å¤´å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    document.getElementById('welcomeSection').style.display = 'block';
                });
        }



        function analyzeStock(retryCount = 0) {
            // éšè—æœç´¢å»ºè®®æ¡†
            hideSuggestions();

            const symbol = document.getElementById('stockSymbol').value.trim();

            if (!symbol) {
                showError('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ');
                return;
            }

            // åˆ¤æ–­è‚¡ç¥¨ä»£ç ç±»å‹
            const isHkStock = symbol.length === 5 && /^\d{5}$/.test(symbol);
            const isAShareStock = symbol.length === 6 && /^\d{6}$/.test(symbol);

            if (!isHkStock && !isAShareStock) {
                showError('è¯·è¾“å…¥æ­£ç¡®çš„è‚¡ç¥¨ä»£ç ï¼šAè‚¡ä¸º6ä½æ•°å­—ï¼Œæ¸¯è‚¡ä¸º5ä½æ•°å­—');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆå¦‚æœè¿˜æ²¡æœ‰æ˜¾ç¤ºçš„è¯ï¼‰
            if (document.getElementById('loadingOverlay').style.display !== 'block') {
                document.getElementById('loadingOverlay').style.display = 'block';
                document.getElementById('loading').style.display = 'block';
                document.querySelector('#loading .loading-text').textContent = `æ­£åœ¨åˆ†æ${isHkStock ? 'æ¸¯è‚¡' : 'Aè‚¡'}æ•°æ®`;
                document.querySelector('#loading .loading-subtext').textContent = 'ç³»ç»Ÿæ­£åœ¨è·å–è´¢åŠ¡æ•°æ®å¹¶ç”Ÿæˆåˆ†ææŠ¥å‘Š';
            }
            document.getElementById('error').style.display = 'none';
            document.getElementById('chartContainer').style.display = 'none';
            document.getElementById('stockInfoSection').style.display = 'none';
            document.getElementById('welcomeSection').style.display = 'none';
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('flipStoneBtn').disabled = true;

            // é‡ç½®åŠ è½½æ­¥éª¤
            resetLoadingSteps();

            // å¼€å§‹åŠ è½½æ­¥éª¤åŠ¨ç”»
            startLoadingSteps();

            if (isHkStock) {
                // æ¸¯è‚¡åˆ†æé€»è¾‘
                analyzeHkStock(symbol);
            } else {
                // Aè‚¡åˆ†æé€»è¾‘
                analyzeAShareStock(symbol);
            }
        }

        function analyzeHkStock(stock, stockName) {
            // è®¾ç½®å…¨å±€è‚¡ç¥¨ä»£ç ï¼Œä¾›è‡ªé€‰è‚¡åŠŸèƒ½ä½¿ç”¨
            window.currentStockCode = stock;
            console.log('analyzeHkStock: è®¾ç½®å…¨å±€è‚¡ç¥¨ä»£ç :', stock);
            
            // æ£€æŸ¥æ¸¯è‚¡åˆ—è¡¨æ˜¯å¦å·²åŠ è½½
            if (!hkStockList || hkStockList.length === 0) {
                showError('æ¸¯è‚¡åˆ—è¡¨å°šæœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åé‡è¯•');
                return;
            }
            
            // å¦‚æœæ²¡æœ‰ä¼ å…¥stockNameå‚æ•°ï¼Œåˆ™ä»å·²åŠ è½½çš„æ¸¯è‚¡åˆ—è¡¨ä¸­è·å–
            if (!stockName) {
                stockName = hkStockList.find(hkStock => hkStock.code === stock)?.name || '';
            }
            
            // å¹¶è¡Œè·å–æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬æ¸¯è‚¡åŸºæœ¬ä¿¡æ¯
            Promise.allSettled([
                fetch(`http://localhost:8888/api/zxm/hk-financial-analysis?stock=${encodeURIComponent(stock)}&stockName=${encodeURIComponent(stockName)}`),
                fetch(`http://localhost:8888/api/zxm/hk-basic-info?stock=${encodeURIComponent(stock)}`),
                fetch(`http://localhost:8888/api/zxm/hk-turnover-distribution?stock=${encodeURIComponent(stock)}`)
            ])
                .then(results => {
                    const [analysisResult, basicInfoResult, turnoverDistributionResult] = results;

                    completeLoading();
                    document.getElementById('analyzeBtn').disabled = false;
                    document.getElementById('flipStoneBtn').disabled = false;

                    // å¤„ç†åŸºæœ¬ä¿¡æ¯ç»“æœ
                    if (basicInfoResult.status === 'fulfilled' && basicInfoResult.value.ok) {
                        basicInfoResult.value.json().then(hkBasicInfo => {
                            displayHkBasicInfo(hkBasicInfo, stock);
                        }).catch(error => {
                            console.warn('æ¸¯è‚¡åŸºæœ¬ä¿¡æ¯è§£æå¤±è´¥:', error);
                        });
                    } else {
                        console.warn('æ¸¯è‚¡åŸºæœ¬ä¿¡æ¯è·å–å¤±è´¥:', basicInfoResult.reason || 'ç½‘ç»œé”™è¯¯');
                        // åŸºæœ¬ä¿¡æ¯å¤±è´¥ä¸å½±å“å›¾è¡¨æ˜¾ç¤º
                    }

                    // å¤„ç†è´¢åŠ¡åˆ†ææ•°æ®ç»“æœ
                    if (analysisResult.status === 'fulfilled' && analysisResult.value.ok) {
                        analysisResult.value.json().then(analysisData => {
                            if (analysisData.success) {
                                displayHkAllCharts(analysisData.debtAnalysis, analysisData.assetAnalysis, analysisData.profitDataAnalysis, analysisData.profitRatioAnalysis, analysisData.financialRatioAnalysis, analysisData.cashFlowAnalysis);

                                // åœ¨å›¾è¡¨å®¹å™¨åˆ›å»ºåï¼Œæ˜¾ç¤ºæ¢æ‰‹ç‡åˆ†å¸ƒå›¾è¡¨
                                setTimeout(() => {
                                    if (turnoverDistributionResult.status === 'fulfilled' && turnoverDistributionResult.value.ok) {
                                        turnoverDistributionResult.value.json().then(turnoverData => {
                                            if (turnoverData.success) {
                                                displayHkTurnoverDistributionChart(turnoverData);
                                            } else {
                                                console.warn('æ¸¯è‚¡æ¢æ‰‹ç‡åˆ†å¸ƒæ•°æ®è·å–å¤±è´¥:', turnoverData.message);
                                            }
                                        }).catch(error => {
                                            console.warn('æ¸¯è‚¡æ¢æ‰‹ç‡åˆ†å¸ƒæ•°æ®è§£æå¤±è´¥:', error);
                                        });
                                    } else {
                                        console.warn('æ¸¯è‚¡æ¢æ‰‹ç‡åˆ†å¸ƒæ•°æ®è·å–å¤±è´¥:', turnoverDistributionResult.reason || 'ç½‘ç»œé”™è¯¯');
                                    }
                                }, 100); // å»¶è¿Ÿ100msç¡®ä¿å®¹å™¨å·²åˆ›å»º
                            } else {
                                showError(analysisData.message || 'æ¸¯è‚¡åˆ†æå¤±è´¥');
                                document.getElementById('welcomeSection').style.display = 'block';
                            }
                        }).catch(error => {
                            console.error('æ¸¯è‚¡è´¢åŠ¡åˆ†ææ•°æ®è§£æå¤±è´¥:', error);
                            showError('æ¸¯è‚¡è´¢åŠ¡åˆ†ææ•°æ®è§£æå¤±è´¥');
                            document.getElementById('welcomeSection').style.display = 'block';
                        });
                    } else {
                        console.error('æ¸¯è‚¡è´¢åŠ¡åˆ†ææ•°æ®è·å–å¤±è´¥:', analysisResult.reason || 'ç½‘ç»œé”™è¯¯');
                        showError('æ¸¯è‚¡è´¢åŠ¡åˆ†ææ•°æ®è·å–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                        document.getElementById('welcomeSection').style.display = 'block';
                    }
                })
                .catch(error => {
                    completeLoading();
                    document.getElementById('analyzeBtn').disabled = false;
                    document.getElementById('flipStoneBtn').disabled = false;
                    showError('æ¸¯è‚¡æ•°æ®è·å–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    document.getElementById('welcomeSection').style.display = 'block';
                });
        }

        function analyzeAShareStock(symbol, stockName) {
            // è®¾ç½®å…¨å±€è‚¡ç¥¨ä»£ç ï¼Œä¾›è‡ªé€‰è‚¡åŠŸèƒ½ä½¿ç”¨
            window.currentStockCode = symbol;
            
            // æ£€æŸ¥è‚¡ç¥¨åˆ—è¡¨æ˜¯å¦å·²åŠ è½½
            if (!aShareStockList || aShareStockList.length === 0) {
                showError('è‚¡ç¥¨åˆ—è¡¨å°šæœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åé‡è¯•');
                return;
            }
            
            // å¦‚æœæ²¡æœ‰ä¼ å…¥stockNameå‚æ•°ï¼Œåˆ™ä»å·²åŠ è½½çš„è‚¡ç¥¨åˆ—è¡¨ä¸­è·å–
            if (!stockName) {
                stockName = aShareStockList.find(stock => stock.code === symbol)?.name || '';
            }
            console.log('Aè‚¡åˆ†æ - è‚¡ç¥¨ä»£ç :', symbol, 'è‚¡ç¥¨åç§°:', stockName, 'è‚¡ç¥¨åˆ—è¡¨é•¿åº¦:', aShareStockList.length);
            
            // å¹¶è¡Œè·å–æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯
            Promise.all([
                fetch(`http://localhost:8888/api/zxm/stock-info?symbol=${encodeURIComponent(symbol)}`),
                fetch(`http://localhost:8888/api/zxm/comprehensive-analysis?symbol=${encodeURIComponent(symbol)}&stockName=${encodeURIComponent(stockName)}`),
                fetch(`http://localhost:8888/api/zxm/valuation-data?symbol=${encodeURIComponent(symbol)}`),
                fetch(`http://localhost:8888/api/zxm/turnover-distribution?symbol=${encodeURIComponent(symbol)}`),
                fetch(`http://localhost:8888/api/zxm/shareholder-data?symbol=${encodeURIComponent(symbol)}`)
            ])
                .then(responses => {
                    return Promise.all(responses.map(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    }));
                })
                .then(([stockInfo, analysisData, valuationData, turnoverDistributionData, shareholderData]) => {
                    completeLoading();
                    document.getElementById('analyzeBtn').disabled = false;
                    document.getElementById('flipStoneBtn').disabled = false;

                    // æ˜¾ç¤ºè‚¡ç¥¨åŸºæœ¬ä¿¡æ¯
                    displayStockInfo(stockInfo);

                    // æ˜¾ç¤ºè´¢åŠ¡åˆ†ææ•°æ®
                    if (analysisData.success) {
                        // æ„å»ºvaluationAnalysisã€turnoverDistributionAnalysiså’ŒshareholderAnalysiså¯¹è±¡
                        const valuationAnalysis = {
                            symbol: symbol,
                            valuationData: valuationData,
                            success: true
                        };

                        const turnoverDistributionAnalysis = {
                            symbol: symbol,
                            turnoverDistributionData: turnoverDistributionData,
                            success: true
                        };

                        const shareholderAnalysis = {
                            symbol: symbol,
                            shareholderData: shareholderData,
                            success: true
                        };

                        displayAllCharts(analysisData.debtAnalysis,
                            analysisData.assetAnalysis,
                            analysisData.profitDataAnalysis,
                            analysisData.profitRatioAnalysis,
                            analysisData.bloodDataAnalysis,
                            analysisData.bloodRatioAnalysis,
                            analysisData.financialRatioAnalysis,
                            valuationAnalysis,
                            turnoverDistributionAnalysis,
                            shareholderAnalysis);
                    } else {
                        showError(analysisData.message || 'åˆ†æå¤±è´¥');
                        document.getElementById('welcomeSection').style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Aè‚¡åˆ†æå¤±è´¥:', error);
                    completeLoading();
                    document.getElementById('analyzeBtn').disabled = false;
                    document.getElementById('flipStoneBtn').disabled = false;
                    showError('æ•°æ®è·å–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    document.getElementById('welcomeSection').style.display = 'block';
                });
        }

        function displayStockInfo(stockInfo) {
            // è®¾ç½®å…¨å±€è‚¡ç¥¨ä»£ç ï¼Œä¾›è‡ªé€‰è‚¡åŠŸèƒ½ä½¿ç”¨
            window.currentStockCode = stockInfo.code;
            
            // æ›´æ–°è‚¡ç¥¨ä¿¡æ¯æ ‡é¢˜
            document.getElementById('stockInfoTitle').textContent = `${stockInfo.name || stockInfo.code} - åŸºæœ¬ä¿¡æ¯`;

            // æ›´æ–°å„ä¸ªä¿¡æ¯å­—æ®µ
            document.getElementById('stockCode').textContent = stockInfo.code || '-';
            document.getElementById('stockName').textContent = stockInfo.name || '-';
            document.getElementById('stockPrice').textContent = stockInfo.latestPrice ? `Â¥${stockInfo.latestPrice}` : '-';
            document.getElementById('stockIndustry').textContent = stockInfo.industry || '-';
            document.getElementById('stockTotalShares').textContent = formatNumber(stockInfo.totalShares);
            document.getElementById('stockCirculatingShares').textContent = formatNumber(stockInfo.circulatingShares);
            document.getElementById('stockTotalMarketValue').textContent = formatMarketValue(stockInfo.totalMarketValue);
            document.getElementById('stockCirculatingMarketValue').textContent = formatMarketValue(stockInfo.circulatingMarketValue);
            document.getElementById('stockListingDate').textContent = formatDate(stockInfo.listingDate);
            document.getElementById('stockRoe').textContent = stockInfo.roe || '-';
            document.getElementById('stockPe').textContent = stockInfo.pe || '-';

            // æ˜¾ç¤ºè‚¡ç¥¨ä¿¡æ¯åŒºåŸŸ
            document.getElementById('stockInfoSection').style.display = 'block';
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºè‡ªé€‰è‚¡
            checkWatchlistStatus(stockInfo.code);
        }

        function displayHkStockInfo(analysisData) {
            // æ›´æ–°æ¸¯è‚¡ä¿¡æ¯æ ‡é¢˜
            document.getElementById('stockInfoTitle').textContent = `${analysisData.stockName || analysisData.stockCode} - æ¸¯è‚¡åŸºæœ¬ä¿¡æ¯`;

            // æ›´æ–°å„ä¸ªä¿¡æ¯å­—æ®µ
            document.getElementById('stockCode').textContent = analysisData.stockCode || '-';
            document.getElementById('stockName').textContent = analysisData.stockName || '-';
            document.getElementById('stockPrice').textContent = '-'; // æ¸¯è‚¡æš‚æ— å®æ—¶ä»·æ ¼
            document.getElementById('stockIndustry').textContent = '-'; // æ¸¯è‚¡æš‚æ— è¡Œä¸šä¿¡æ¯
            document.getElementById('stockTotalShares').textContent = '-'; // æ¸¯è‚¡æš‚æ— æ€»è‚¡æœ¬
            document.getElementById('stockCirculatingShares').textContent = '-'; // æ¸¯è‚¡æš‚æ— æµé€šè‚¡æœ¬
            document.getElementById('stockTotalMarketValue').textContent = '-'; // æ¸¯è‚¡æš‚æ— å¸‚å€¼
            document.getElementById('stockCirculatingMarketValue').textContent = '-'; // æ¸¯è‚¡æš‚æ— æµé€šå¸‚å€¼
            document.getElementById('stockListingDate').textContent = formatDate(analysisData.reportPeriod);
            document.getElementById('stockRoe').textContent = '-'; // æ¸¯è‚¡æš‚æ— ROE
            document.getElementById('stockPe').textContent = '-'; // æ¸¯è‚¡æš‚æ— PE

            // æ˜¾ç¤ºè‚¡ç¥¨ä¿¡æ¯åŒºåŸŸ
            document.getElementById('stockInfoSection').style.display = 'block';
        }

        function formatNumber(value) {
            if (!value) return '-';
            const num = parseFloat(value);
            if (isNaN(num)) return value;

            // è¿‡äº¿çš„æ•°å­—æ˜¾ç¤ºä¸ºäº¿å•ä½ï¼Œä¿ç•™ä¸¤ä½å°æ•°
            if (num >= 1e8) {
                return (num / 1e8).toFixed(2) + 'äº¿';
            }
            // è¿‡ä¸‡çš„æ•°å­—æ˜¾ç¤ºä¸ºä¸‡å•ä½ï¼Œä¿ç•™ä¸¤ä½å°æ•°
            else if (num >= 1e4) {
                return (num / 1e4).toFixed(2) + 'ä¸‡';
            }
            // å°äº1ä¸‡çš„æ•°å­—ï¼Œå¦‚æœæ˜¯æ•´æ•°åˆ™æ˜¾ç¤ºæ•´æ•°ï¼Œå¦åˆ™ä¿ç•™ä¸¤ä½å°æ•°
            else {
                if (Number.isInteger(num)) {
                    return num.toLocaleString();
                } else {
                    return num.toFixed(2);
                }
            }
        }

        function formatMarketValue(value) {
            if (!value) return '-';
            const num = parseFloat(value);
            if (isNaN(num)) return value;

            // è¿‡ä¸‡äº¿çš„å¸‚å€¼æ˜¾ç¤ºä¸ºä¸‡äº¿å•ä½ï¼Œä¿ç•™ä¸¤ä½å°æ•°
            if (num >= 1e12) {
                return 'Â¥' + (num / 1e12).toFixed(2) + 'ä¸‡äº¿';
            }
            // è¿‡äº¿çš„å¸‚å€¼æ˜¾ç¤ºä¸ºäº¿å•ä½ï¼Œä¿ç•™ä¸¤ä½å°æ•°
            else if (num >= 1e8) {
                return 'Â¥' + (num / 1e8).toFixed(2) + 'äº¿';
            }
            // è¿‡ä¸‡çš„å¸‚å€¼æ˜¾ç¤ºä¸ºä¸‡å•ä½ï¼Œä¿ç•™ä¸¤ä½å°æ•°
            else if (num >= 1e4) {
                return 'Â¥' + (num / 1e4).toFixed(2) + 'ä¸‡';
            }
            // å°äº1ä¸‡çš„å¸‚å€¼ï¼Œå¦‚æœæ˜¯æ•´æ•°åˆ™æ˜¾ç¤ºæ•´æ•°ï¼Œå¦åˆ™ä¿ç•™ä¸¤ä½å°æ•°
            else {
                if (Number.isInteger(num)) {
                    return 'Â¥' + num.toLocaleString();
                } else {
                    return 'Â¥' + num.toFixed(2);
                }
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            if (dateStr.length === 8) {
                return dateStr.substring(0, 4) + '-' + dateStr.substring(4, 6) + '-' + dateStr.substring(6, 8);
            }
            return dateStr;
        }

        function displayAllCharts(debtData, assetData, profitDataData, profitRatioData, bloodDataData, bloodRatioData, financialRatioData, valuationData, turnoverDistributionData, shareholderData) {
            // ä¿å­˜æ•°æ®åˆ°å…¨å±€å˜é‡
            globalAShareAnalysisData = {
                debtData, assetData, profitDataData, profitRatioData, bloodDataData, bloodRatioData, financialRatioData, valuationData, turnoverDistributionData, shareholderData
            };
            
            // æ£€æŸ¥æ•°æ®
            const debtRatios = debtData && debtData.yearlyRatios ? debtData.yearlyRatios : null;
            const assetRatios = assetData && assetData.yearlyRatios ? assetData.yearlyRatios : null;
            const profitDataRatios = profitDataData && profitDataData.yearlyRatios ? profitDataData.yearlyRatios : null;
            const profitRatioRatios = profitRatioData && profitRatioData.yearlyRatios ? profitRatioData.yearlyRatios : null;
            const bloodDataDatas = bloodDataData && bloodDataData.yearlyDatas ? bloodDataData.yearlyDatas : null;
            const bloodRatioRatios = bloodRatioData && bloodRatioData.yearlyRatios ? bloodRatioData.yearlyRatios : null;
            const financialRatioRatios = financialRatioData && financialRatioData.yearlyRatios ? financialRatioData.yearlyRatios : null;

            // åªè¦æœ‰ä»»ä¸€æ•°æ®å­˜åœ¨å°±ç»§ç»­æ˜¾ç¤º
            const hasAnyData = (debtRatios && Object.keys(debtRatios).length > 0) ||
                (assetRatios && Object.keys(assetRatios).length > 0) ||
                (profitDataRatios && Object.keys(profitDataRatios).length > 0) ||
                (profitRatioRatios && Object.keys(profitRatioRatios).length > 0) ||
                (bloodDataDatas && Object.keys(bloodDataDatas).length > 0) ||
                (bloodRatioRatios && Object.keys(bloodRatioRatios).length > 0) ||
                (financialRatioRatios && Object.keys(financialRatioRatios).length > 0);

            if (!hasAnyData) {
                showError('æœªæ‰¾åˆ°è¯¥è‚¡ç¥¨çš„è´¢åŠ¡æ•°æ®');
                document.getElementById('welcomeSection').style.display = 'block';
                return;
            }

            // åˆ›å»ºå›¾è¡¨å®¹å™¨ - ä¸¤åˆ—å¸ƒå±€
            const chartContainer = document.getElementById('chartContainer');
            let chartHtml = '';

            // ç¬¬ä¸€è¡Œï¼šè´Ÿå€ºç»“æ„ + èµ„äº§ç»“æ„
            if ((debtRatios && Object.keys(debtRatios).length > 0) ||
                (assetRatios && Object.keys(assetRatios).length > 0)) {
                chartHtml += `<div class="chart-row">`;

                if (debtRatios && Object.keys(debtRatios).length > 0) {
                    chartHtml += `<div class="chart-wrapper">
                        <div id="debtChart" class="chart"></div>
                    </div>`;
                }

                if (assetRatios && Object.keys(assetRatios).length > 0) {
                    chartHtml += `<div class="chart-wrapper">
                        <div id="assetChart" class="chart"></div>
                    </div>`;
                }

                chartHtml += `</div>`;
            }

            // ç¬¬äºŒè¡Œï¼šåˆ©æ¶¦è¡¨æ•°æ® + è´¢åŠ¡æ¯”ç‡
            if ((profitDataRatios && Object.keys(profitDataRatios).length > 0) ||
                (profitRatioRatios && Object.keys(profitRatioRatios).length > 0)) {
                chartHtml += `<div class="chart-row">`;

                if (profitDataRatios && Object.keys(profitDataRatios).length > 0) {
                    chartHtml += `<div class="chart-wrapper">
                        <div id="profitDataChart" class="chart"></div>
                    </div>`;
                }

                if (profitRatioRatios && Object.keys(profitRatioRatios).length > 0) {
                    chartHtml += `<div class="chart-wrapper">
                        <div id="profitRatioChart" class="chart"></div>
                    </div>`;
                }

                chartHtml += `</div>`;
            }

            // ç¬¬ä¸‰è¡Œï¼šè´¢åŠ¡æ¯”ç‡åˆ†æ + é€ è¡€èƒ½åŠ›æ¯”ç‡
            if ((financialRatioRatios && Object.keys(financialRatioRatios).length > 0) ||
                (bloodRatioRatios && Object.keys(bloodRatioRatios).length > 0)) {
                chartHtml += `<div class="chart-row">`;

                if (financialRatioRatios && Object.keys(financialRatioRatios).length > 0) {
                    chartHtml += `<div class="chart-wrapper">
                        <div id="financialRatioChart" class="chart"></div>
                    </div>`;
                }

                if (bloodRatioRatios && Object.keys(bloodRatioRatios).length > 0) {
                    chartHtml += `<div class="chart-wrapper">
                        <div id="bloodRatioChart" class="chart"></div>
                    </div>`;
                }

                chartHtml += `</div>`;
            }

            // ç¬¬å››è¡Œï¼šé€ è¡€èƒ½åŠ›æ•°æ®
            if (bloodDataDatas && Object.keys(bloodDataDatas).length > 0) {
                chartHtml += `<div class="chart-row">`;
                chartHtml += `<div class="chart-wrapper">
                    <div id="bloodDataChart" class="chart"></div>
                </div>`;
                chartHtml += `</div>`;
            }

            // ç¬¬äº”è¡Œï¼šå¸‚ç›ˆç‡æ•°æ®
            if (valuationData && valuationData.valuationData && valuationData.valuationData.length > 0) {
                chartHtml += `<div class="chart-row">`;
                chartHtml += `<div class="chart-wrapper">
                    <div id="valuationChart" class="chart"></div>
                </div>`;
                chartHtml += `</div>`;
            }

            // ç¬¬å…­è¡Œï¼šæ¢æ‰‹ç‡åˆ†å¸ƒæ•°æ®
            if (turnoverDistributionData && turnoverDistributionData.turnoverDistributionData && turnoverDistributionData.turnoverDistributionData.success) {
                chartHtml += `<div class="chart-row">`;
                chartHtml += `<div class="chart-wrapper">
                    <div id="turnoverDistributionChart" class="chart"></div>
                </div>`;
                chartHtml += `</div>`;
            }

            // ç¬¬ä¸ƒè¡Œï¼šè‚¡ä¸œæˆ·æ•°æ•°æ®
            if (shareholderData && shareholderData.shareholderData && shareholderData.shareholderData.success && shareholderData.shareholderData.shareholderData && shareholderData.shareholderData.shareholderData.length > 0) {
                chartHtml += `<div class="chart-row">`;
                chartHtml += `<div class="chart-wrapper">
                    <div id="shareholderChart" class="chart"></div>
                </div>`;
                chartHtml += `</div>`;
            }

            chartContainer.innerHTML = chartHtml;

            // è·å–å½“å‰switchçŠ¶æ€
            const analysisSwitch = document.getElementById('analysisSwitch');
            const useYearlyData = analysisSwitch ? analysisSwitch.checked : false;

            // æ˜¾ç¤ºè´Ÿå€ºç»“æ„å›¾è¡¨
            if (debtRatios && Object.keys(debtRatios).length > 0) {
                try {
                    displayDebtChart(debtData, useYearlyData);
                } catch (e) {
                    console.warn('è´Ÿå€ºå›¾è¡¨æ˜¾ç¤ºå¤±è´¥:', e);
                }
            }

            // æ˜¾ç¤ºèµ„äº§ç»“æ„å›¾è¡¨
            if (assetRatios && Object.keys(assetRatios).length > 0) {
                try {
                    displayAssetChart(assetData, useYearlyData);
                } catch (e) {
                    console.warn('èµ„äº§å›¾è¡¨æ˜¾ç¤ºå¤±è´¥:', e);
                }
            }

            // æ˜¾ç¤ºåˆ©æ¶¦è¡¨æ•°æ®å›¾è¡¨
            if (profitDataRatios && Object.keys(profitDataRatios).length > 0) {
                try {
                    displayProfitDataChart(profitDataData, useYearlyData);
                } catch (e) {
                    console.warn('åˆ©æ¶¦è¡¨æ•°æ®å›¾è¡¨æ˜¾ç¤ºå¤±è´¥:', e);
                }
            }

            // æ˜¾ç¤ºåˆ©æ¶¦è¡¨æ¯”ç‡å›¾è¡¨
            if (profitRatioRatios && Object.keys(profitRatioRatios).length > 0) {
                try {
                    displayProfitRatioChart(profitRatioData, useYearlyData);
                } catch (e) {
                    console.warn('è´¢åŠ¡æ¯”ç‡å›¾è¡¨æ˜¾ç¤ºå¤±è´¥:', e);
                }
            }

            // æ˜¾ç¤ºé€ è¡€èƒ½åŠ›å’Œè¾“è¡€èƒ½åŠ›æ•°æ®å›¾è¡¨
            if (bloodDataDatas && Object.keys(bloodDataDatas).length > 0) {
                try {
                    displayBloodDataChart(bloodDataData, useYearlyData);
                } catch (e) {
                    console.warn('é€ è¡€èƒ½åŠ›æ•°æ®å›¾è¡¨æ˜¾ç¤ºå¤±è´¥:', e);
                }
            }

            // æ˜¾ç¤ºè´¢åŠ¡æ¯”ç‡å›¾è¡¨
            if (financialRatioRatios && Object.keys(financialRatioRatios).length > 0) {
                try {
                    displayFinancialRatioChart(financialRatioData, useYearlyData);
                } catch (e) {
                    console.warn('è´¢åŠ¡æ¯”ç‡å›¾è¡¨æ˜¾ç¤ºå¤±è´¥:', e);
                }
            }

            // æ˜¾ç¤ºé€ è¡€èƒ½åŠ›å’Œè¾“è¡€èƒ½åŠ›æ¯”ç‡å›¾è¡¨
            if (bloodRatioRatios && Object.keys(bloodRatioRatios).length > 0) {
                try {
                    displayBloodRatioChart(bloodRatioData, useYearlyData);
                } catch (e) {
                    console.warn('é€ è¡€èƒ½åŠ›æ¯”ç‡å›¾è¡¨æ˜¾ç¤ºå¤±è´¥:', e);
                }
            }

            // æ˜¾ç¤ºå¸‚ç›ˆç‡å›¾è¡¨
            if (valuationData && valuationData.valuationData && valuationData.valuationData.length > 0) {
                try {
                    displayValuationChart(valuationData.valuationData);
                } catch (e) {
                    console.warn('å¸‚ç›ˆç‡å›¾è¡¨æ˜¾ç¤ºå¤±è´¥:', e);
                }
            }

            // æ˜¾ç¤ºæ¢æ‰‹ç‡åˆ†å¸ƒå›¾è¡¨
            if (turnoverDistributionData && turnoverDistributionData.turnoverDistributionData && turnoverDistributionData.turnoverDistributionData.success) {
                try {
                    displayTurnoverDistributionChart(turnoverDistributionData.turnoverDistributionData);
                } catch (e) {
                    console.warn('æ¢æ‰‹ç‡åˆ†å¸ƒå›¾è¡¨æ˜¾ç¤ºå¤±è´¥:', e);
                }
            }

            // æ˜¾ç¤ºè‚¡ä¸œæˆ·æ•°å›¾è¡¨
            if (shareholderData && shareholderData.shareholderData && shareholderData.shareholderData.success && shareholderData.shareholderData.shareholderData && shareholderData.shareholderData.shareholderData.length > 0) {
                try {
                    displayShareholderChart(shareholderData.shareholderData);
                } catch (e) {
                    console.warn('è‚¡ä¸œæˆ·æ•°å›¾è¡¨æ˜¾ç¤ºå¤±è´¥:', e);
                }
            }

            chartContainer.style.display = 'block';

            // ç¡®ä¿å›¾è¡¨æ­£ç¡®æ¸²æŸ“
            setTimeout(() => {
                if (window.debtChart && typeof window.debtChart.resize === 'function') {
                    window.debtChart.resize();
                }
                if (window.assetChart && typeof window.assetChart.resize === 'function') {
                    window.assetChart.resize();
                }
                if (window.profitDataChart && typeof window.profitDataChart.resize === 'function') {
                    window.profitDataChart.resize();
                }
                if (window.profitRatioChart && typeof window.profitRatioChart.resize === 'function') {
                    window.profitRatioChart.resize();
                }
                if (window.bloodDataChart && typeof window.bloodDataChart.resize === 'function') {
                    window.bloodDataChart.resize();
                }
                if (window.bloodRatioChart && typeof window.bloodRatioChart.resize === 'function') {
                    window.bloodRatioChart.resize();
                }
                if (window.financialRatioChart && typeof window.financialRatioChart.resize === 'function') {
                    window.financialRatioChart.resize();
                }
                if (window.valuationChart && typeof window.valuationChart.resize === 'function') {
                    window.valuationChart.resize();
                }
                if (window.turnoverDistributionChart && typeof window.turnoverDistributionChart.resize === 'function') {
                    window.turnoverDistributionChart.resize();
                }
                if (window.shareholderChart && typeof window.shareholderChart.resize === 'function') {
                    window.shareholderChart.resize();
                }
            }, 100);
        }

        function displayDebtChart(data, useYearlyData = false) {
            if (!data || !data.yearlyRatios) {
                console.warn('è´Ÿå€ºæ•°æ®ä¸ºç©º');
                return;
            }
            
            let yearlyRatios, periods;
            
            if (useYearlyData) {
                // æŒ‰å¹´åº¦æ¨¡å¼ï¼šæå–å¹´åº¦æ•°æ®
                const yearlyData = {};
                Object.keys(data.yearlyRatios).forEach(period => {
                    const year = period.split('-')[0]; // æå–å¹´ä»½
                    if (!yearlyData[year]) {
                        yearlyData[year] = {};
                    }
                    // åˆå¹¶åŒä¸€å¹´ä»½çš„æ•°æ®ï¼ˆå–æœ€æ–°æŠ¥å‘ŠæœŸçš„æ•°æ®ï¼‰
                    Object.keys(data.yearlyRatios[period]).forEach(indicator => {
                        yearlyData[year][indicator] = data.yearlyRatios[period][indicator];
                    });
                });
                yearlyRatios = yearlyData;
                periods = Object.keys(yearlyData).sort();
            } else {
                // æŒ‰æŠ¥å‘ŠæœŸæ¨¡å¼ï¼šä¿æŒåŸæœ‰é€»è¾‘
                yearlyRatios = data.yearlyRatios;
                periods = Object.keys(yearlyRatios).sort();
            }

            const totalDebtData = [];
            const operatingDebtData = [];
            const financialDebtData = [];
            const currentDebtData = [];
            const nonCurrentDebtData = [];

            periods.forEach(period => {
                const ratios = yearlyRatios[period];
                totalDebtData.push(ratios.totalDebtRatio != null ? parseFloat((ratios.totalDebtRatio * 100).toFixed(2)) : null);
                operatingDebtData.push(ratios.operatingDebtRatio != null ? parseFloat((ratios.operatingDebtRatio * 100).toFixed(2)) : null);
                financialDebtData.push(ratios.financialDebtRatio != null ? parseFloat((ratios.financialDebtRatio * 100).toFixed(2)) : null);
                currentDebtData.push(ratios.currentDebtRatio != null ? parseFloat((ratios.currentDebtRatio * 100).toFixed(2)) : null);
                nonCurrentDebtData.push(ratios.nonCurrentDebtRatio != null ? parseFloat((ratios.nonCurrentDebtRatio * 100).toFixed(2)) : null);
            });

            const series = [
                { name: 'æ€»è´Ÿå€ºç‡', data: totalDebtData, color: '#e74c3c' },
                { name: 'ç»è¥æ€§è´Ÿå€ºç‡', data: operatingDebtData, color: '#3498db' },
                { name: 'é‡‘èæ€§è´Ÿå€ºç‡', data: financialDebtData, color: '#2ecc71' },
                { name: 'æµåŠ¨è´Ÿå€ºç‡', data: currentDebtData, color: '#f39c12' },
                { name: 'éæµåŠ¨è´Ÿå€ºç‡', data: nonCurrentDebtData, color: '#9b59b6' }
            ];

            const title = useYearlyData ? `${data.symbol} è´Ÿå€ºç»“æ„åˆ†æï¼ˆæŒ‰å¹´åº¦ï¼‰` : `${data.symbol} è´Ÿå€ºç»“æ„åˆ†æ`;
            createChart('debtChart', title, periods, series, true);
        }

        function displayAssetChart(data, useYearlyData = false) {
            if (!data || !data.yearlyRatios) {
                console.warn('èµ„äº§æ•°æ®ä¸ºç©º');
                return;
            }
            
            let yearlyRatios, periods;
            
            if (useYearlyData) {
                // æŒ‰å¹´åº¦æ¨¡å¼ï¼šæå–å¹´åº¦æ•°æ®
                const yearlyData = {};
                Object.keys(data.yearlyRatios).forEach(period => {
                    const year = period.split('-')[0]; // æå–å¹´ä»½
                    if (!yearlyData[year]) {
                        yearlyData[year] = {};
                    }
                    // åˆå¹¶åŒä¸€å¹´ä»½çš„æ•°æ®ï¼ˆå–æœ€æ–°æŠ¥å‘ŠæœŸçš„æ•°æ®ï¼‰
                    Object.keys(data.yearlyRatios[period]).forEach(indicator => {
                        yearlyData[year][indicator] = data.yearlyRatios[period][indicator];
                    });
                });
                yearlyRatios = yearlyData;
                periods = Object.keys(yearlyData).sort();
            } else {
                // æŒ‰æŠ¥å‘ŠæœŸæ¨¡å¼ï¼šä¿æŒåŸæœ‰é€»è¾‘
                yearlyRatios = data.yearlyRatios;
                periods = Object.keys(yearlyRatios).sort();
            }

            // åŠ¨æ€è·å–æ‰€æœ‰èµ„äº§é¡¹ç›®
            const allAssetItems = new Set();
            periods.forEach(period => {
                const ratios = yearlyRatios[period];
                if (ratios) {
                    Object.keys(ratios).forEach(key => {
                        allAssetItems.add(key);
                    });
                }
            });

            // ä¸ºæ¯ä¸ªèµ„äº§é¡¹ç›®åˆ›å»ºæ•°æ®æ•°ç»„
            const assetDataMap = {};
            const colors = [
                '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6',
                '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6366f1',
                '#14b8a6', '#f43f5e', '#a855f7', '#0ea5e9', '#22c55e',
                '#f97316', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b',
                '#dc2626', '#7c3aed', '#059669', '#d97706', '#be185d',
                '#0891b2', '#65a30d', '#ea580c', '#9333ea', '#0d9488'
            ];

            // éšæœºæ‰“ä¹±é¢œè‰²æ•°ç»„ï¼Œç¡®ä¿é¢œè‰²åˆ†é…æ›´åŠ å¤šæ ·åŒ–
            const shuffledColors = [...colors].sort(() => Math.random() - 0.5);

            allAssetItems.forEach((item, index) => {
                assetDataMap[item] = {
                    name: item,
                    data: [],
                    color: shuffledColors[index % shuffledColors.length]
                };
            });

            // å¡«å……æ•°æ®
            periods.forEach(period => {
                const ratios = yearlyRatios[period];
                allAssetItems.forEach(item => {
                    const value = ratios && ratios[item] != null ? parseFloat((ratios[item] * 100).toFixed(2)) : null;
                    assetDataMap[item].data.push(value);
                });
            });

            // è½¬æ¢ä¸ºseriesæ ¼å¼
            const series = Object.values(assetDataMap);

            // è°ƒè¯•ï¼šæ‰“å°é¢œè‰²åˆ†é…æƒ…å†µ
            console.log('èµ„äº§å›¾è¡¨é¢œè‰²åˆ†é…:', series.map(s => ({ name: s.name, color: s.color })));

            const title = useYearlyData ? `${data.symbol} èµ„äº§ç»“æ„åˆ†æï¼ˆæŒ‰å¹´åº¦ï¼‰` : `${data.symbol} èµ„äº§ç»“æ„åˆ†æ`;
            createChart('assetChart', title, periods, series, true);
        }

        function displayProfitDataChart(data, useYearlyData = false) {
            if (!data || !data.yearlyRatios) {
                console.warn('åˆ©æ¶¦è¡¨æ•°æ®ä¸ºç©º');
                return;
            }
            
            let yearlyRatios, periods;
            
            if (useYearlyData) {
                // æŒ‰å¹´åº¦æ¨¡å¼ï¼šæå–å¹´åº¦æ•°æ®
                const yearlyData = {};
                Object.keys(data.yearlyRatios).forEach(period => {
                    const year = period.split('-')[0]; // æå–å¹´ä»½
                    if (!yearlyData[year]) {
                        yearlyData[year] = {};
                    }
                    // åˆå¹¶åŒä¸€å¹´ä»½çš„æ•°æ®ï¼ˆå–æœ€æ–°æŠ¥å‘ŠæœŸçš„æ•°æ®ï¼‰
                    Object.keys(data.yearlyRatios[period]).forEach(indicator => {
                        yearlyData[year][indicator] = data.yearlyRatios[period][indicator];
                    });
                });
                yearlyRatios = yearlyData;
                periods = Object.keys(yearlyData).sort();
            } else {
                // æŒ‰æŠ¥å‘ŠæœŸæ¨¡å¼ï¼šä¿æŒåŸæœ‰é€»è¾‘
                yearlyRatios = data.yearlyRatios;
                periods = Object.keys(yearlyRatios).sort();
            }

            // åŠ¨æ€è·å–æ‰€æœ‰åˆ©æ¶¦è¡¨æ•°æ®é¡¹ç›®
            const allProfitDataItems = new Set();
            periods.forEach(period => {
                const ratios = yearlyRatios[period];
                if (ratios) {
                    Object.keys(ratios).forEach(key => {
                        allProfitDataItems.add(key);
                    });
                }
            });

            // ä¸ºæ¯ä¸ªé¡¹ç›®åˆ›å»ºæ•°æ®æ•°ç»„
            const profitDataMap = {};
            const colors = [
                '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6',
                '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6366f1',
                '#14b8a6', '#f43f5e', '#a855f7', '#0ea5e9', '#22c55e',
                '#f97316', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b'
            ];

            // éšæœºæ‰“ä¹±é¢œè‰²æ•°ç»„ï¼Œç¡®ä¿é¢œè‰²åˆ†é…æ›´åŠ å¤šæ ·åŒ–
            const shuffledColors = [...colors].sort(() => Math.random() - 0.5);

            allProfitDataItems.forEach((item, index) => {
                profitDataMap[item] = {
                    name: item,
                    data: [],
                    color: shuffledColors[index % shuffledColors.length]
                };
            });

            // å¡«å……æ•°æ®
            periods.forEach(period => {
                const ratios = yearlyRatios[period];
                allProfitDataItems.forEach(item => {
                    // å¯¹äºåˆ©æ¶¦è¡¨æ•°æ®ï¼Œç›´æ¥æ˜¾ç¤ºæ•°å€¼ï¼Œä¸è½¬æ¢ä¸ºç™¾åˆ†æ¯”
                    const value = ratios && ratios[item] != null ? parseFloat(ratios[item].toFixed(2)) : null;
                    profitDataMap[item].data.push(value);
                });
            });

            // è½¬æ¢ä¸ºseriesæ ¼å¼
            const series = Object.values(profitDataMap);

            const title = useYearlyData ? `${data.symbol} åˆ©æ¶¦è¡¨æ•°æ®åˆ†æï¼ˆæŒ‰å¹´åº¦ï¼‰` : `${data.symbol} åˆ©æ¶¦è¡¨æ•°æ®åˆ†æ`;
            createChart('profitDataChart', title, periods, series, false);
        }

        function displayProfitRatioChart(data, useYearlyData = false) {
            if (!data || !data.yearlyRatios) {
                console.warn('è´¢åŠ¡æ¯”ç‡æ•°æ®ä¸ºç©º');
                return;
            }
            
            let yearlyRatios, periods;
            
            if (useYearlyData) {
                // æŒ‰å¹´åº¦æ¨¡å¼ï¼šæå–å¹´åº¦æ•°æ®
                const yearlyData = {};
                Object.keys(data.yearlyRatios).forEach(period => {
                    const year = period.split('-')[0]; // æå–å¹´ä»½
                    if (!yearlyData[year]) {
                        yearlyData[year] = {};
                    }
                    // åˆå¹¶åŒä¸€å¹´ä»½çš„æ•°æ®ï¼ˆå–æœ€æ–°æŠ¥å‘ŠæœŸçš„æ•°æ®ï¼‰
                    Object.keys(data.yearlyRatios[period]).forEach(indicator => {
                        yearlyData[year][indicator] = data.yearlyRatios[period][indicator];
                    });
                });
                yearlyRatios = yearlyData;
                periods = Object.keys(yearlyData).sort();
            } else {
                // æŒ‰æŠ¥å‘ŠæœŸæ¨¡å¼ï¼šä¿æŒåŸæœ‰é€»è¾‘
                yearlyRatios = data.yearlyRatios;
                periods = Object.keys(yearlyRatios).sort();
            }

            // åŠ¨æ€è·å–æ‰€æœ‰è´¢åŠ¡æ¯”ç‡é¡¹ç›®
            const allProfitRatioItems = new Set();
            periods.forEach(period => {
                const ratios = yearlyRatios[period];
                if (ratios) {
                    Object.keys(ratios).forEach(key => {
                        allProfitRatioItems.add(key);
                    });
                }
            });

            // ä¸ºæ¯ä¸ªé¡¹ç›®åˆ›å»ºæ•°æ®æ•°ç»„
            const profitRatioMap = {};
            const colors = [
                '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6',
                '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6366f1',
                '#14b8a6', '#f43f5e', '#a855f7', '#0ea5e9', '#22c55e',
                '#f97316', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b'
            ];

            // éšæœºæ‰“ä¹±é¢œè‰²æ•°ç»„ï¼Œç¡®ä¿é¢œè‰²åˆ†é…æ›´åŠ å¤šæ ·åŒ–
            const shuffledColors = [...colors].sort(() => Math.random() - 0.5);

            allProfitRatioItems.forEach((item, index) => {
                profitRatioMap[item] = {
                    name: item,
                    data: [],
                    color: shuffledColors[index % shuffledColors.length]
                };
            });

            // å¡«å……æ•°æ®
            periods.forEach(period => {
                const ratios = yearlyRatios[period];
                allProfitRatioItems.forEach(item => {
                    const value = ratios && ratios[item] != null ? parseFloat((ratios[item] * 100).toFixed(2)) : null;
                    profitRatioMap[item].data.push(value);
                });
            });

            // è½¬æ¢ä¸ºseriesæ ¼å¼
            const series = Object.values(profitRatioMap);

            const title = useYearlyData ? `${data.symbol} åˆ©æ¶¦åˆ†æï¼ˆæŒ‰å¹´åº¦ï¼‰` : `${data.symbol} åˆ©æ¶¦åˆ†æ`;
            createChart('profitRatioChart', title, periods, series, true);
        }

        function displayBloodDataChart(data) {
            if (!data || !data.yearlyDatas) {
                console.warn('é€ è¡€èƒ½åŠ›æ•°æ®ä¸ºç©º');
                return;
            }
            const yearlyDatas = data.yearlyDatas;
            const periods = Object.keys(yearlyDatas).sort();

            // åŠ¨æ€è·å–æ‰€æœ‰é€ è¡€èƒ½åŠ›é¡¹ç›®
            const allBloodDataItems = new Set();
            periods.forEach(period => {
                const datas = yearlyDatas[period];
                if (datas) {
                    Object.keys(datas).forEach(key => {
                        allBloodDataItems.add(key);
                    });
                }
            });

            // ä¸ºæ¯ä¸ªé¡¹ç›®åˆ›å»ºæ•°æ®æ•°ç»„
            const bloodDataMap = {};
            const colors = [
                '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6',
                '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6366f1',
                '#14b8a6', '#f43f5e', '#a855f7', '#0ea5e9', '#22c55e',
                '#f97316', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b'
            ];

            // éšæœºæ‰“ä¹±é¢œè‰²æ•°ç»„ï¼Œç¡®ä¿é¢œè‰²åˆ†é…æ›´åŠ å¤šæ ·åŒ–
            const shuffledColors = [...colors].sort(() => Math.random() - 0.5);

            allBloodDataItems.forEach((item, index) => {
                bloodDataMap[item] = {
                    name: item,
                    data: [],
                    color: shuffledColors[index % shuffledColors.length]
                };
            });

            // å¡«å……æ•°æ®
            periods.forEach(period => {
                const datas = yearlyDatas[period];
                allBloodDataItems.forEach(item => {
                    // å¯¹äºé€ è¡€èƒ½åŠ›æ•°æ®ï¼Œç›´æ¥æ˜¾ç¤ºæ•°å€¼ï¼Œä¸è½¬æ¢ä¸ºç™¾åˆ†æ¯”
                    const value = datas && datas[item] != null ? parseFloat(datas[item].toFixed(2)) : null;
                    bloodDataMap[item].data.push(value);
                });
            });

            // è½¬æ¢ä¸ºseriesæ ¼å¼
            const series = Object.values(bloodDataMap);

            createChart('bloodDataChart', `${data.symbol} é€ è¡€èƒ½åŠ›å’Œè¾“è¡€èƒ½åŠ›æ•°æ®ï¼ˆç»å¯¹é‡‘é¢ï¼‰`, periods, series, false);
        }

        function displayFinancialRatioChart(data) {
            if (!data || !data.yearlyRatios) {
                console.warn('è´¢åŠ¡æ¯”ç‡æ•°æ®ä¸ºç©º');
                return;
            }
            const yearlyRatios = data.yearlyRatios;
            const periods = Object.keys(yearlyRatios).sort();

            // åŠ¨æ€è·å–æ‰€æœ‰è´¢åŠ¡æ¯”ç‡é¡¹ç›®
            const allFinancialRatioItems = new Set();
            periods.forEach(period => {
                const ratios = yearlyRatios[period];
                if (ratios) {
                    Object.keys(ratios).forEach(key => {
                        allFinancialRatioItems.add(key);
                    });
                }
            });

            // ä¸ºæ¯ä¸ªé¡¹ç›®åˆ›å»ºæ•°æ®æ•°ç»„
            const financialRatioMap = {};
            const colors = [
                '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6',
                '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6366f1',
                '#14b8a6', '#f43f5e', '#a855f7', '#0ea5e9', '#22c55e',
                '#f97316', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b'
            ];

            // éšæœºæ‰“ä¹±é¢œè‰²æ•°ç»„ï¼Œç¡®ä¿é¢œè‰²åˆ†é…æ›´åŠ å¤šæ ·åŒ–
            const shuffledColors = [...colors].sort(() => Math.random() - 0.5);

            allFinancialRatioItems.forEach((item, index) => {
                financialRatioMap[item] = {
                    name: item,
                    data: [],
                    color: shuffledColors[index % shuffledColors.length]
                };
            });

            // å¡«å……æ•°æ®
            periods.forEach(period => {
                const ratios = yearlyRatios[period];
                allFinancialRatioItems.forEach(item => {
                    let value = ratios && ratios[item] != null ? parseFloat((ratios[item] * 100).toFixed(2)) : null;
                    // å¤„ç†Infinityå’ŒNaNçš„æƒ…å†µ
                    if (value === Infinity || value === -Infinity || isNaN(value)) {
                        value = null;
                    }
                    financialRatioMap[item].data.push(value);
                });
            });

            // è½¬æ¢ä¸ºseriesæ ¼å¼
            const series = Object.values(financialRatioMap);

            createChart('financialRatioChart', `${data.symbol} è´¢åŠ¡æ¯”ç‡åˆ†æ`, periods, series, true);
        }

        function displayBloodRatioChart(data) {
            if (!data || !data.yearlyRatios) {
                console.warn('é€ è¡€èƒ½åŠ›æ¯”ç‡æ•°æ®ä¸ºç©º');
                return;
            }
            const yearlyRatios = data.yearlyRatios;
            const periods = Object.keys(yearlyRatios).sort();

            // åŠ¨æ€è·å–æ‰€æœ‰é€ è¡€èƒ½åŠ›é¡¹ç›®
            const allBloodRatioItems = new Set();
            periods.forEach(period => {
                const ratios = yearlyRatios[period];
                if (ratios) {
                    Object.keys(ratios).forEach(key => {
                        allBloodRatioItems.add(key);
                    });
                }
            });

            // ä¸ºæ¯ä¸ªé¡¹ç›®åˆ›å»ºæ•°æ®æ•°ç»„
            const bloodRatioMap = {};
            const colors = [
                '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6',
                '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6366f1',
                '#14b8a6', '#f43f5e', '#a855f7', '#0ea5e9', '#22c55e',
                '#f97316', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b'
            ];

            // éšæœºæ‰“ä¹±é¢œè‰²æ•°ç»„ï¼Œç¡®ä¿é¢œè‰²åˆ†é…æ›´åŠ å¤šæ ·åŒ–
            const shuffledColors = [...colors].sort(() => Math.random() - 0.5);

            allBloodRatioItems.forEach((item, index) => {
                bloodRatioMap[item] = {
                    name: item,
                    data: [],
                    color: shuffledColors[index % shuffledColors.length]
                };
            });

            // å¡«å……æ•°æ®
            periods.forEach(period => {
                const ratios = yearlyRatios[period];
                allBloodRatioItems.forEach(item => {
                    // å¯¹äºé€ è¡€èƒ½åŠ›æ¯”ç‡ï¼Œè½¬æ¢ä¸ºç™¾åˆ†æ¯”æ˜¾ç¤º
                    const value = ratios && ratios[item] != null ? parseFloat((ratios[item] * 100).toFixed(2)) : null;
                    bloodRatioMap[item].data.push(value);
                });
            });

            // è½¬æ¢ä¸ºseriesæ ¼å¼
            const series = Object.values(bloodRatioMap);

            createChart('bloodRatioChart', `${data.symbol} é€ è¡€èƒ½åŠ›å’Œè¾“è¡€èƒ½åŠ›å æ¯”åˆ†æ`, periods, series, true);
        }

        function createChart(containerId, title, periods, series, showPercentage = true) {
            const chartDom = document.getElementById(containerId);
            if (!chartDom) {
                console.error(`å›¾è¡¨å®¹å™¨ ${containerId} ä¸å­˜åœ¨`);
                return;
            }

            // æ£€æŸ¥å¹¶é”€æ¯å·²å­˜åœ¨çš„å›¾è¡¨å®ä¾‹
            if (window[containerId] && typeof window[containerId].dispose === 'function') {
                window[containerId].dispose();
            }

            // åˆ›å»ºæ–°çš„å›¾è¡¨å®ä¾‹
            try {
                window[containerId] = echarts.init(chartDom, null, {
                    renderer: 'canvas',
                    useDirtyRect: false
                });

                // ç¡®ä¿tooltipå®¹å™¨æœ‰æ­£ç¡®çš„z-index
                const tooltipContainer = chartDom.querySelector('.echarts-tooltip');
                if (tooltipContainer) {
                    tooltipContainer.style.zIndex = '9999';
                }
            } catch (error) {
                console.error(`åˆ›å»ºå›¾è¡¨å¤±è´¥: ${error.message}`);
                return;
            }

            const option = {
                title: {
                    text: title,
                    left: 'center',
                    top: 16,
                    textStyle: {
                        fontSize: 18,
                        fontWeight: '700',
                        color: '#111827',
                        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                        textShadow: '0 1px 2px rgba(0, 0, 0, 0.1)'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(255, 255, 255, 0.98)',
                    borderColor: '#e5e7eb',
                    borderWidth: 1,
                    borderRadius: 8,
                    boxShadow: '0 10px 25px rgba(0, 0, 0, 0.1)',
                    textStyle: { color: '#374151', fontSize: 13 },
                    confine: false,
                    appendToBody: true,
                    enterable: true,
                    hideDelay: 100,
                    formatter: function (params) {
                        let result = `<div style="font-weight: 700; margin-bottom: 8px; color: #111827; font-size: 14px;">${params[0].axisValue}</div>`;

                        // è¿‡æ»¤æœ‰æ•ˆæ•°æ®å¹¶æŒ‰æ•°å€¼ä»å¤§åˆ°å°æ’åºï¼ˆåŒ…æ‹¬0å€¼ï¼‰
                        const validParams = params.filter(param => param.value != null && param.value !== Infinity && param.value !== -Infinity && !isNaN(param.value) && param.value !== '');
                        validParams.sort((a, b) => parseFloat(b.value) - parseFloat(a.value));

                        validParams.forEach(param => {
                            const unit = showPercentage ? '%' : '';
                            const displayValue = showPercentage ? parseFloat(param.value).toFixed(1) : formatNumber(param.value);
                            result += `<div style="margin: 3px 0; display: flex; align-items: center; gap: 6px;">
                                <span style="display: inline-block; width: 8px; height: 8px; background: ${param.color}; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1);"></span>
                                <span style="margin-right: 6px; color: #4b5563; font-size: 12px;">${param.seriesName}:</span> 
                                <span style="color: #111827; font-weight: 700; font-size: 12px;">${displayValue}${unit}</span>
                            </div>`;
                        });
                        return result;
                    }
                },
                legend: {
                    data: series.map(s => s.name),
                    top: 45,
                    textStyle: {
                        fontSize: 11,
                        color: '#374151',
                        fontWeight: '500'
                    },
                    itemGap: 6,
                    itemWidth: 8,
                    itemHeight: 4,
                    type: 'scroll',
                    pageButtonItemGap: 3,
                    pageButtonGap: 3,
                    pageButtonPosition: 'end',
                    pageIconColor: '#6b7280',
                    pageIconInactiveColor: '#d1d5db',
                    pageIconSize: 8,
                    pageTextStyle: { color: '#6b7280', fontSize: 9 },
                    selectedMode: true,
                    formatter: function (name) {
                        // æˆªæ–­è¿‡é•¿çš„å›¾ä¾‹åç§°
                        return name.length > 6 ? name.substring(0, 6) + '...' : name;
                    }
                },
                grid: {
                    left: '6%',
                    right: '6%',
                    bottom: '15%',
                    top: '22%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: periods,
                    axisLabel: {
                        fontSize: 11,
                        color: '#6b7280',
                        fontWeight: '500',
                        margin: 8,
                        interval: Math.floor(periods.length / 8) // åªæ˜¾ç¤ºéƒ¨åˆ†æŠ¥å‘ŠæœŸæ ‡ç­¾
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#e5e7eb',
                            width: 0.5
                        }
                    },
                    axisTick: {
                        show: false
                    },
                    boundaryGap: false
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        formatter: showPercentage ? function (value) {
                            return parseFloat(value).toFixed(2) + '%';
                        } : function (value) {
                            return formatNumber(value);
                        },
                        fontSize: 12,
                        color: '#6b7280',
                        fontWeight: '500',
                        margin: 6
                    },
                    axisLine: {
                        show: false
                    },
                    axisTick: {
                        show: false
                    },
                    splitLine: {
                        lineStyle: {
                            color: '#e5e7eb',
                            width: 1,
                            type: 'solid'
                        }
                    }
                },
                series: series.map((s, index) => {
                    // å¼ºåˆ¶ä½¿ç”¨é¢„å®šä¹‰çš„ä¸°å¯Œé¢œè‰²æ–¹æ¡ˆ
                    const richColors = [
                        '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6',
                        '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6366f1',
                        '#14b8a6', '#f43f5e', '#a855f7', '#0ea5e9', '#22c55e',
                        '#dc2626', '#7c3aed', '#059669', '#d97706', '#be185d'
                    ];
                    const lineColor = richColors[index % richColors.length];

                    return {
                        name: s.name,
                        type: 'line',
                        data: s.data,
                        color: lineColor,
                        symbol: 'none', // ç§»é™¤æ‰€æœ‰æ•°æ®ç‚¹ç¬¦å·
                        lineStyle: {
                            width: 1.8,
                            color: lineColor,
                            type: 'solid', // ç»Ÿä¸€ä½¿ç”¨å®çº¿
                            shadowColor: lineColor.replace(')', ', 0.2)').replace('rgb', 'rgba'),
                            shadowBlur: 2,
                            shadowOffsetY: 1
                        },
                        itemStyle: {
                            color: lineColor
                        },
                        // ç§»é™¤å¡«å……åŒºåŸŸ
                        emphasis: {
                            itemStyle: {
                                color: lineColor
                            },
                            lineStyle: {
                                width: 2.5,
                                color: lineColor,
                                shadowColor: lineColor.replace(')', ', 0.3)').replace('rgb', 'rgba'),
                                shadowBlur: 4,
                                shadowOffsetY: 2
                            }
                        },
                        connectNulls: false,
                        smooth: false
                    };
                }),
                animation: true,
                animationDuration: 1500,
                animationEasing: 'cubicOut',
                animationDelay: function (idx) {
                    return idx * 100;
                }
            };

            try {
                window[containerId].setOption(option, true);

                // ç›‘å¬tooltipæ˜¾ç¤ºäº‹ä»¶ï¼Œç¡®ä¿z-indexæ­£ç¡®
                window[containerId].on('showTip', function () {
                    setTimeout(() => {
                        const tooltips = document.querySelectorAll('.echarts-tooltip');
                        tooltips.forEach(tooltip => {
                            tooltip.style.zIndex = '9999';
                            tooltip.style.position = 'absolute';
                        });
                    }, 10);
                });

            } catch (error) {
                console.error(`è®¾ç½®å›¾è¡¨é€‰é¡¹å¤±è´¥: ${error.message}`);
            }
        }



        function showError(message) {
            document.getElementById('error').textContent = message;
            document.getElementById('error').style.display = 'block';
        }

        function showSuccess(message) {
            // åˆ›å»ºæˆåŠŸæ¶ˆæ¯å…ƒç´ 
            const successElement = document.createElement('div');
            successElement.className = 'success-message';
            successElement.textContent = message;
            successElement.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #059669 0%, #10b981 100%);
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 8px 25px rgba(5, 150, 105, 0.3);
                z-index: 10000;
                font-weight: 500;
                animation: slideInRight 0.3s ease-out;
            `;
            
            // æ·»åŠ åŠ¨ç”»æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(successElement);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                successElement.style.animation = 'slideOutRight 0.3s ease-in';
                successElement.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (successElement.parentNode) {
                        successElement.parentNode.removeChild(successElement);
                    }
                }, 300);
            }, 3000);
        }

        // æ£€æŸ¥è‡ªé€‰è‚¡çŠ¶æ€
        function checkWatchlistStatus(stockCode) {
            if (!stockCode || stockCode === '-') return;
            
            fetch(`/api/watchlist/stock/${stockCode}`)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                })
                .then(data => {
                    if (data && data.success && data.data) {
                        // è‚¡ç¥¨åœ¨è‡ªé€‰è‚¡ä¸­
                        updateWatchlistButtons(data.data);
                    } else if (data && !data.success) {
                        // è‚¡ç¥¨ä¸åœ¨è‡ªé€‰è‚¡ä¸­ï¼Œè¿™æ˜¯æ­£å¸¸æƒ…å†µ
                        console.log(`è‚¡ç¥¨ ${stockCode} ä¸åœ¨è‡ªé€‰è‚¡ä¸­: ${data.message}`);
                        updateWatchlistButtons(null);
                    } else {
                        // æ•°æ®æ ¼å¼å¼‚å¸¸
                        console.error('è‡ªé€‰è‚¡çŠ¶æ€æŸ¥è¯¢è¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸:', data);
                        updateWatchlistButtons(null);
                    }
                })
                .catch(error => {
                    console.error('æ£€æŸ¥è‡ªé€‰è‚¡çŠ¶æ€æ—¶å‘ç”Ÿé”™è¯¯:', error);
                    updateWatchlistButtons(null);
                });
        }
        
        // æ›´æ–°è‡ªé€‰è‚¡æŒ‰é’®çŠ¶æ€
        function updateWatchlistButtons(watchlistData) {
            const watchBtn = document.getElementById('addToWatchlistBtn');
            const portfolioBtn = document.getElementById('addToPortfolioBtn');
            const stockNameElement = document.getElementById('stockName');
            const stockInfoTitle = document.getElementById('stockInfoTitle');
            
            // è·å–åŸå§‹è‚¡ç¥¨åç§°ï¼ˆä¸åŒ…å«æ ‡è®°ï¼‰
            let originalStockName = '';
            if (stockNameElement) {
                // Aè‚¡é¡µé¢æœ‰stockNameå…ƒç´ 
                originalStockName = stockNameElement.textContent.replace(/[è§‚æŒ]/g, '').trim();
            } else if (stockInfoTitle) {
                // æ¸¯è‚¡é¡µé¢æ²¡æœ‰stockNameå…ƒç´ ï¼Œä»æ ‡é¢˜ä¸­æå–
                originalStockName = stockInfoTitle.textContent.replace(/[è§‚æŒ]/g, '').trim();
            }
            
            if (watchlistData) {
                // è‚¡ç¥¨å·²åœ¨è‡ªé€‰è‚¡ä¸­
                const stockType = watchlistData.stockType;
                const stockName = stockNameElement ? stockNameElement.textContent : '';
                
                if (stockType === 1) {
                    // è§‚å¯Ÿè‚¡ - åœ¨æ ‡é¢˜å·¦ä¾§æ˜¾ç¤ºæ ‡è®°
                    if (stockInfoTitle && stockInfoTitle.textContent) {
                        // å…ˆæ¸…ç†æ ‡é¢˜ä¸­çš„åŸæœ‰æ ‡è®°ï¼Œç„¶åæ·»åŠ æ–°æ ‡è®°
                        const cleanTitle = stockInfoTitle.textContent.replace(/[è§‚æŒ]/g, '').trim();
                        stockInfoTitle.innerHTML = `<span class="watch-badge">è§‚</span> ${cleanTitle}`;
                    }
                    // ä¸ºæ¸¯è‚¡é¡µé¢æ·»åŠ æ ‡è®°åˆ°å…¬å¸åç§°æ ‡é¢˜
                    const companyTitle = document.querySelector('.stock-info-header h2');
                    if (companyTitle && !companyTitle.innerHTML.includes('è§‚')) {
                        const cleanCompanyTitle = companyTitle.textContent.replace(/[è§‚æŒ]/g, '').trim();
                        companyTitle.innerHTML = `<span class="watch-badge">è§‚</span> ${cleanCompanyTitle}`;
                    }
                    watchBtn.style.display = 'none';
                    portfolioBtn.textContent = 'è®¾ä¸ºæŒä»“è‚¡';
                    portfolioBtn.onclick = () => addToWatchlist(2);
                    portfolioBtn.style.display = 'inline-block';
                } else if (stockType === 2) {
                    // æŒä»“è‚¡ - åœ¨æ ‡é¢˜å·¦ä¾§æ˜¾ç¤ºæ ‡è®°
                    if (stockInfoTitle && stockInfoTitle.textContent) {
                        // å…ˆæ¸…ç†æ ‡é¢˜ä¸­çš„åŸæœ‰æ ‡è®°ï¼Œç„¶åæ·»åŠ æ–°æ ‡è®°
                        const cleanTitle = stockInfoTitle.textContent.replace(/[è§‚æŒ]/g, '').trim();
                        stockInfoTitle.innerHTML = `<span class="portfolio-badge">æŒ</span> ${cleanTitle}`;
                    }
                    // ä¸ºæ¸¯è‚¡é¡µé¢æ·»åŠ æ ‡è®°åˆ°å…¬å¸åç§°æ ‡é¢˜
                    const companyTitle = document.querySelector('.stock-info-header h2');
                    if (companyTitle && !companyTitle.innerHTML.includes('æŒ')) {
                        const cleanCompanyTitle = companyTitle.textContent.replace(/[è§‚æŒ]/g, '').trim();
                        companyTitle.innerHTML = `<span class="portfolio-badge">æŒ</span> ${cleanCompanyTitle}`;
                    }
                    portfolioBtn.style.display = 'none';
                    watchBtn.textContent = 'è®¾ä¸ºè§‚å¯Ÿè‚¡';
                    watchBtn.onclick = () => addToWatchlist(1);
                    watchBtn.style.display = 'inline-block';
                }
                
                // æ·»åŠ åˆ é™¤æŒ‰é’®
                addDeleteButton();
            } else {
                // è‚¡ç¥¨ä¸åœ¨è‡ªé€‰è‚¡ä¸­ï¼Œæ˜¾ç¤ºé»˜è®¤æŒ‰é’®
                // ç§»é™¤æ ‡é¢˜ä¸­çš„æ ‡è®°
                if (stockInfoTitle) {
                    stockInfoTitle.innerHTML = stockInfoTitle.textContent.replace(/[è§‚æŒ]/g, '').trim();
                }
                // ä¸ºæ¸¯è‚¡é¡µé¢ç§»é™¤å…¬å¸åç§°æ ‡é¢˜ä¸­çš„æ ‡è®°
                const companyTitle = document.querySelector('.stock-info-header h2');
                if (companyTitle) {
                    companyTitle.innerHTML = companyTitle.textContent.replace(/[è§‚æŒ]/g, '').trim();
                }
                watchBtn.textContent = 'åŠ è§‚å¯Ÿ';
                watchBtn.onclick = () => addToWatchlist(1);
                watchBtn.style.display = 'inline-block';
                portfolioBtn.textContent = 'è®¾ä¸ºæŒä»“è‚¡';
                portfolioBtn.onclick = () => addToWatchlist(2);
                portfolioBtn.style.display = 'inline-block';
                
                // ç§»é™¤åˆ é™¤æŒ‰é’®
                removeDeleteButton();
            }
        }
        
        // æ·»åŠ åˆ é™¤æŒ‰é’®
        function addDeleteButton() {
            if (document.getElementById('deleteWatchlistBtn')) return;
            
            const deleteBtn = document.createElement('button');
            deleteBtn.id = 'deleteWatchlistBtn';
            deleteBtn.className = 'action-btn delete-btn';
            deleteBtn.textContent = 'åˆ é™¤';
            deleteBtn.onclick = deleteFromWatchlist;
            
            const actionsDiv = document.querySelector('.stock-actions');
            actionsDiv.appendChild(deleteBtn);
        }
        
        // ç§»é™¤åˆ é™¤æŒ‰é’®
        function removeDeleteButton() {
            const deleteBtn = document.getElementById('deleteWatchlistBtn');
            if (deleteBtn) {
                deleteBtn.remove();
            }
        }
        
        // åˆ é™¤è‡ªé€‰è‚¡
        function deleteFromWatchlist() {
            let stockCode = '';
            
            // é¦–å…ˆå°è¯•ä»DOMå…ƒç´ è·å–è‚¡ç¥¨ä»£ç 
            const stockCodeElement = document.getElementById('stockCode');
            if (stockCodeElement && stockCodeElement.textContent && stockCodeElement.textContent !== '-') {
                stockCode = stockCodeElement.textContent;
            } else if (window.currentStockCode) {
                // å¦‚æœDOMå…ƒç´ è·å–ä¸åˆ°ï¼Œä»å…¨å±€å˜é‡è·å–
                stockCode = window.currentStockCode;
            }
            
            if (!stockCode) {
                showError('æ— æ³•è·å–è‚¡ç¥¨ä»£ç ï¼Œåˆ é™¤å¤±è´¥');
                return;
            }
            
            if (confirm('ç¡®å®šè¦ä»è‡ªé€‰è‚¡ä¸­åˆ é™¤è¿™åªè‚¡ç¥¨å—ï¼Ÿ')) {
                fetch(`/api/watchlist/delete/${stockCode}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showSuccess('å·²ä»è‡ªé€‰è‚¡ä¸­åˆ é™¤');
                        // é‡æ–°æ£€æŸ¥çŠ¶æ€
                        checkWatchlistStatus(stockCode);
                    } else {
                        showError('åˆ é™¤å¤±è´¥ï¼š' + data.message);
                    }
                })
                .catch(error => {
                    console.error('åˆ é™¤è‡ªé€‰è‚¡å¤±è´¥:', error);
                    showError('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                });
            }
        }

        // æ·»åŠ è‡ªé€‰è‚¡åŠŸèƒ½
        function addToWatchlist(stockType) {
            let stockCode = '';
            let stockName = '';
            
            // è·å–è‚¡ç¥¨ä»£ç ï¼Œå…¼å®¹Aè‚¡å’Œæ¸¯è‚¡é¡µé¢
            const stockCodeElement = document.getElementById('stockCode');
            if (stockCodeElement) {
                stockCode = stockCodeElement.textContent;
            }
            
            // å¦‚æœä»DOMå…ƒç´ è·å–ä¸åˆ°è‚¡ç¥¨ä»£ç ï¼Œå°è¯•ä»å…¨å±€å˜é‡è·å–
            if (!stockCode || stockCode === '-') {
                // æ£€æŸ¥æ˜¯å¦æœ‰å…¨å±€å­˜å‚¨çš„å½“å‰è‚¡ç¥¨ä»£ç 
                console.log('DOMå…ƒç´ è·å–ä¸åˆ°è‚¡ç¥¨ä»£ç ï¼Œæ£€æŸ¥å…¨å±€å˜é‡:', window.currentStockCode);
                if (window.currentStockCode) {
                    stockCode = window.currentStockCode;
                    console.log('ä»å…¨å±€å˜é‡è·å–åˆ°è‚¡ç¥¨ä»£ç :', stockCode);
                }
            }
            
            console.log('æœ€ç»ˆè·å–çš„è‚¡ç¥¨ä»£ç :', stockCode);
            console.log('æœ€ç»ˆè·å–çš„è‚¡ç¥¨åç§°:', stockName);
            
            // è·å–è‚¡ç¥¨åç§°ï¼Œå…¼å®¹Aè‚¡å’Œæ¸¯è‚¡é¡µé¢
            const stockNameElement = document.getElementById('stockName');
            const stockInfoTitle = document.getElementById('stockInfoTitle');
            
            if (stockNameElement && stockNameElement.textContent && stockNameElement.textContent !== '-') {
                // Aè‚¡é¡µé¢æœ‰stockNameå…ƒç´ 
                stockName = stockNameElement.textContent;
            } else if (stockInfoTitle && stockInfoTitle.textContent) {
                // æ¸¯è‚¡é¡µé¢æ²¡æœ‰stockNameå…ƒç´ ï¼Œä»æ ‡é¢˜ä¸­æå–
                stockName = stockInfoTitle.textContent.replace(/[è§‚æŒ]/g, '').trim();
            }
            
            // å¦‚æœè¿˜æ˜¯è·å–ä¸åˆ°è‚¡ç¥¨åç§°ï¼Œå°è¯•ä»é¡µé¢å…¶ä»–å…ƒç´ è·å–
            if (!stockName || stockName === '-') {
                // å°è¯•ä»æ¸¯è‚¡é¡µé¢çš„å…¬å¸åç§°å…ƒç´ è·å–
                const companyNameElement = document.querySelector('.stock-info-header h2');
                if (companyNameElement && companyNameElement.textContent) {
                    stockName = companyNameElement.textContent.split('ï¼ˆ')[0]; // å–ä¸­æ–‡åç§°éƒ¨åˆ†
                }
            }
            
            if (!stockCode || stockCode === '-' || !stockName || stockName === '-') {
                showError('è‚¡ç¥¨ä¿¡æ¯ä¸å®Œæ•´ï¼Œæ— æ³•æ·»åŠ åˆ°è‡ªé€‰è‚¡');
                return;
            }

            const stockData = {
                stockCode: stockCode,
                stockName: stockName,
                stockType: stockType
            };

            console.log('å‘é€çš„æ•°æ®:', stockData);

            const typeText = stockType === 1 ? 'è§‚å¯Ÿè‚¡' : 'æŒä»“è‚¡';
            
            // è°ƒç”¨åç«¯APIæ·»åŠ è‡ªé€‰è‚¡
            fetch('/api/watchlist/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(stockData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess(`å·²æˆåŠŸ${data.message.includes('æ›´æ–°') ? 'æ›´æ–°' : 'æ·»åŠ '}ä¸º${typeText}`);
                    // é‡æ–°æ£€æŸ¥çŠ¶æ€
                    checkWatchlistStatus(stockCode);
                } else {
                    showError('æ“ä½œå¤±è´¥ï¼š' + data.message);
                }
            })
            .catch(error => {
                console.error('æ·»åŠ è‡ªé€‰è‚¡å¤±è´¥:', error);
                showError('æ·»åŠ è‡ªé€‰è‚¡å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
        }

        // å…¨å±€tooltipä¿®å¤å‡½æ•°
        function fixTooltipZIndex() {
            const tooltips = document.querySelectorAll('.echarts-tooltip');
            tooltips.forEach(tooltip => {
                tooltip.style.zIndex = '9999';
                tooltip.style.position = 'absolute';
                tooltip.style.pointerEvents = 'auto';
            });
        }

        // å®šæœŸæ£€æŸ¥å¹¶ä¿®å¤tooltip z-index
        setInterval(fixTooltipZIndex, 100);

        // é‡ç½®åŠ è½½æ­¥éª¤
        function resetLoadingSteps() {
            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.remove('active');
                const icon = step.querySelector('.loading-step-icon');
                icon.textContent = i;
            }
        }

        // å¼€å§‹åŠ è½½æ­¥éª¤åŠ¨ç”»
        function startLoadingSteps() {
            let currentStep = 1;

            function activateStep(stepNumber) {
                const step = document.getElementById(`step${stepNumber}`);
                if (step) {
                    step.classList.add('active');
                    const icon = step.querySelector('.loading-step-icon');
                    icon.textContent = 'âœ“';
                }
            }

            // æ¨¡æ‹ŸåŠ è½½æ­¥éª¤
            const stepIntervals = [800, 1200, 1000, 800]; // æ¯ä¸ªæ­¥éª¤çš„æŒç»­æ—¶é—´

            stepIntervals.forEach((interval, index) => {
                setTimeout(() => {
                    activateStep(index + 1);
                }, stepIntervals.slice(0, index).reduce((a, b) => a + b, 0));
            });
        }

        // ç¿»çŸ³å¤´ä¸“ç”¨åŠ¨ç”»
        function startFlipStoneAnimation() {
            const loadingText = document.querySelector('#loading .loading-text');
            const loadingSubtext = document.querySelector('#loading .loading-subtext');
            const loadingSteps = document.querySelector('.loading-steps');

            // éšè—åŸæœ‰çš„æ­¥éª¤
            loadingSteps.style.display = 'none';

            // åŠ¨ç”»é˜¶æ®µ1ï¼šå¼€å§‹ç¿»çŸ³å¤´
            loadingText.textContent = 'ğŸ” æ­£åœ¨ç¿»çŸ³å¤´æ‰¾è‚¡ç¥¨';
            loadingSubtext.textContent = 'ç³»ç»Ÿæ­£åœ¨éšæœºé€‰æ‹©ä¸€åªè‚¡ç¥¨è¿›è¡Œåˆ†æ';

            // åŠ¨ç”»é˜¶æ®µ2ï¼šæ‰¾åˆ°è‚¡ç¥¨
            setTimeout(() => {
                loadingText.textContent = 'ğŸ’ æ‰¾åˆ°äº†ä¸€åªï¼';
                loadingSubtext.textContent = 'æ­£åœ¨å‡†å¤‡åˆ†ææŠ¥å‘Šï¼Œè¯·ç¨å€™...';
                // æ·»åŠ æ‰¾åˆ°è‚¡ç¥¨çš„è§†è§‰åé¦ˆ
                loadingText.style.transform = 'scale(1.1)';
                loadingText.style.transition = 'transform 0.3s ease';
                setTimeout(() => {
                    loadingText.style.transform = 'scale(1)';
                    // ç›´æ¥åˆ‡æ¢åˆ°æ­£å¸¸åˆ†æåŠ¨ç”»
                    setTimeout(() => {
                        // æ˜¾ç¤ºåŸæœ‰çš„æ­¥éª¤ï¼ˆæ­£å¸¸åˆ†æåŠ¨ç”»ï¼‰
                        loadingSteps.style.display = 'flex';
                        // é‡ç½®æ­¥éª¤çŠ¶æ€
                        resetLoadingSteps();
                        // ä½¿ç”¨æ­£å¸¸åˆ†æåŠ¨ç”»çš„æ–‡æœ¬
                        loadingText.textContent = 'æ­£åœ¨åˆ†æAè‚¡æ•°æ®';
                        loadingSubtext.textContent = 'ç³»ç»Ÿæ­£åœ¨è·å–è´¢åŠ¡æ•°æ®å¹¶ç”Ÿæˆåˆ†ææŠ¥å‘Š';
                    }, 500);
                }, 300);
            }, 1500);


        }

        // å®ŒæˆåŠ è½½
        function completeLoading() {
            const loadingSteps = document.querySelector('.loading-steps');

            // å¦‚æœæ­¥éª¤è¢«éšè—äº†ï¼ˆç¿»çŸ³å¤´æ¨¡å¼ï¼‰ï¼Œé‡æ–°æ˜¾ç¤º
            if (loadingSteps.style.display === 'none') {
                loadingSteps.style.display = 'flex';
            }

            // æ¿€æ´»æ‰€æœ‰æ­¥éª¤
            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.add('active');
                const icon = step.querySelector('.loading-step-icon');
                icon.textContent = 'âœ“';
            }

            // æ¸…é™¤ç¿»çŸ³å¤´åŠ¨ç”»æ•ˆæœ
            const loadingText = document.querySelector('#loading .loading-text');
            loadingText.style.animation = '';

            // çŸ­æš‚å»¶è¿Ÿåéšè—åŠ è½½ç•Œé¢
            setTimeout(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('loading').style.display = 'none';
            }, 500);
        }



        // å…¨å±€å˜é‡å­˜å‚¨è‚¡ç¥¨åˆ—è¡¨
        let aShareStockList = [];
        let hkStockList = [];
        let filteredStocks = [];
        let selectedIndex = -1;

        // é¡µé¢åŠ è½½æ—¶è·å–è‚¡ç¥¨åˆ—è¡¨
        window.addEventListener('load', function () {
            loadStockLists();
        });

        // åŠ è½½è‚¡ç¥¨åˆ—è¡¨
        function loadStockLists() {
            // å¹¶è¡ŒåŠ è½½Aè‚¡å’Œæ¸¯è‚¡åˆ—è¡¨
            Promise.all([
                fetch('http://localhost:8888/api/zxm/stock-list'),
                fetch('http://localhost:8888/api/zxm/hk-stock-list')
            ])
                .then(responses => {
                    return Promise.all(responses.map(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    }));
                })
                .then(([aShareData, hkData]) => {
                    if (aShareData && aShareData.length > 0) {
                        aShareStockList = aShareData;
                        console.log('Aè‚¡åˆ—è¡¨åŠ è½½æˆåŠŸï¼Œå…±', aShareStockList.length, 'åªè‚¡ç¥¨');
                    }
                    if (hkData && hkData.length > 0) {
                        hkStockList = hkData;
                        console.log('æ¸¯è‚¡åˆ—è¡¨åŠ è½½æˆåŠŸï¼Œå…±', hkStockList.length, 'åªè‚¡ç¥¨');
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½è‚¡ç¥¨åˆ—è¡¨å¤±è´¥:', error);
                });
        }

        // æœç´¢è‚¡ç¥¨
        function searchStocks(query) {
            if (!query || query.length < 1) {
                hideSuggestions();
                return;
            }

            const results = [];
            const lowerQuery = query.toLowerCase();

            // æœç´¢Aè‚¡è‚¡ç¥¨ï¼ˆä»£ç æˆ–åç§°åŒ¹é…ï¼‰
            aShareStockList.forEach(stock => {
                if (stock.code && stock.name) {
                    const codeMatch = stock.code.includes(query);
                    const nameMatch = stock.name.toLowerCase().includes(lowerQuery);

                    if (codeMatch || nameMatch) {
                        results.push({
                            ...stock,
                            type: 'ashare',
                            matchType: codeMatch ? 'code' : 'name'
                        });
                    }
                }
            });

            // æœç´¢æ¸¯è‚¡è‚¡ç¥¨ï¼ˆä»£ç æˆ–åç§°åŒ¹é…ï¼‰
            hkStockList.forEach(stock => {
                if (stock.code && stock.name) {
                    const codeMatch = stock.code.includes(query);
                    const nameMatch = stock.name.toLowerCase().includes(lowerQuery);

                    if (codeMatch || nameMatch) {
                        results.push({
                            ...stock,
                            type: 'hk',
                            matchType: codeMatch ? 'code' : 'name'
                        });
                    }
                }
            });

            // é™åˆ¶æ˜¾ç¤ºæ•°é‡
            filteredStocks = results.slice(0, 10);
            showSuggestions();
        }

        // æ˜¾ç¤ºå»ºè®®
        function showSuggestions() {
            const suggestionsDiv = document.getElementById('stockSuggestions');
            if (filteredStocks.length === 0) {
                hideSuggestions();
                return;
            }

            suggestionsDiv.innerHTML = '';
            filteredStocks.forEach((stock, index) => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                const typeClass = stock.type === 'hk' ? 'hk' : 'ashare';
                const typeText = stock.type === 'hk' ? 'æ¸¯è‚¡' : 'Aè‚¡';

                item.innerHTML = `
                    <div>
                        <div class="suggestion-code">${stock.code}</div>
                        <div class="suggestion-name">${stock.name}</div>
                    </div>
                    <span class="suggestion-type ${typeClass}">${typeText}</span>
                `;

                item.addEventListener('click', () => selectStock(stock));
                item.addEventListener('mouseenter', () => {
                    selectedIndex = index;
                    updateSelection();
                });

                suggestionsDiv.appendChild(item);
            });

            suggestionsDiv.style.display = 'block';
            selectedIndex = -1;
        }

        // éšè—å»ºè®®
        function hideSuggestions() {
            document.getElementById('stockSuggestions').style.display = 'none';
            selectedIndex = -1;
        }

        // æ›´æ–°é€‰æ‹©çŠ¶æ€
        function updateSelection() {
            const items = document.querySelectorAll('.suggestion-item');
            items.forEach((item, index) => {
                if (index === selectedIndex) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        // é€‰æ‹©è‚¡ç¥¨
        function selectStock(stock) {
            document.getElementById('stockSymbol').value = stock.code;
            hideSuggestions();
        }

        // è¾“å…¥æ¡†äº‹ä»¶å¤„ç†
        const stockInput = document.getElementById('stockSymbol');

        stockInput.addEventListener('input', function (e) {
            const query = e.target.value.trim();
            searchStocks(query);
        });

        stockInput.addEventListener('keydown', function (e) {
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (selectedIndex < filteredStocks.length - 1) {
                    selectedIndex++;
                    updateSelection();
                }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (selectedIndex > 0) {
                    selectedIndex--;
                    updateSelection();
                } else if (selectedIndex === 0) {
                    selectedIndex = -1;
                    updateSelection();
                }
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedIndex >= 0 && filteredStocks[selectedIndex]) {
                    selectStock(filteredStocks[selectedIndex]);
                } else {
                    analyzeStock();
                }
            } else if (e.key === 'Escape') {
                hideSuggestions();
            }
        });

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—å»ºè®®
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.input-wrapper')) {
                hideSuggestions();
            }
        });

        // å›è½¦é”®è§¦å‘åˆ†æï¼ˆä¿ç•™åŸæœ‰åŠŸèƒ½ï¼‰
        stockInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && selectedIndex === -1) {
                analyzeStock();
            }
        });

        function displayValuationChart(valuationData) {
            if (!valuationData || valuationData.length === 0) {
                console.warn('ä¼°å€¼æ•°æ®ä¸ºç©º');
                return;
            }

            // æŒ‰æ—¥æœŸæ’åº
            const sortedData = valuationData.sort((a, b) => new Date(a.date) - new Date(b.date));

            const dates = sortedData.map(item => {
                // å°†ISOæ—¥æœŸæ ¼å¼è½¬æ¢ä¸ºæ›´å‹å¥½çš„æ ¼å¼
                const date = new Date(item.date);
                return date.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            });

            const valueData = sortedData.map(item => {
                const value = parseFloat(item.value);
                return isNaN(value) ? null : value;
            });

            const series = [
                { name: 'ä¼°å€¼æŒ‡æ ‡', data: valueData, color: '#e74c3c' }
            ];

            // è·å–è‚¡ç¥¨ä»£ç ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼
            const symbol = valuationData[0] && valuationData[0].symbol ? valuationData[0].symbol : 'è‚¡ç¥¨';
            createChart('valuationChart', `${symbol} å†å²å¸‚ç›ˆç‡(TTM)è¶‹åŠ¿`, dates, series, false);
        }

        function displayTurnoverDistributionChart(turnoverDistributionData) {
            if (!turnoverDistributionData || !turnoverDistributionData.success) {
                console.warn('æ¢æ‰‹ç‡åˆ†å¸ƒæ•°æ®ä¸ºç©º');
                return;
            }

            const intervalCounts = turnoverDistributionData.intervalCounts;
            const intervalLabels = turnoverDistributionData.intervalLabels;
            const latestIntervalIndex = turnoverDistributionData.latestIntervalIndex;
            const latestTurnover = turnoverDistributionData.latestTurnover;
            const latestDate = turnoverDistributionData.latestDate;
            const symbol = turnoverDistributionData.symbol;

            // å‡†å¤‡æŸ±çŠ¶å›¾æ•°æ®
            const data = [];
            for (let i = 0; i < intervalCounts.length; i++) {
                const item = {
                    value: intervalCounts[i],
                    itemStyle: {
                        color: i === latestIntervalIndex ? '#e74c3c' : '#3498db' // æœ€æ–°åŒºé—´æ ‡è®°ä¸ºçº¢è‰²
                    }
                };
                data.push(item);
            }

            // åˆ›å»ºæŸ±çŠ¶å›¾
            const chart = echarts.init(document.getElementById('turnoverDistributionChart'));
            window.turnoverDistributionChart = chart;

            const option = {
                title: {
                    text: `${symbol} æ¢æ‰‹ç‡åˆ†å¸ƒåˆ†æ`,
                    left: 'center',
                    top: 16,
                    textStyle: {
                        fontSize: 18,
                        fontWeight: '600',
                        color: '#1f2937',
                        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(255, 255, 255, 0.98)',
                    borderColor: '#e5e7eb',
                    borderWidth: 1,
                    borderRadius: 8,
                    boxShadow: '0 10px 25px rgba(0, 0, 0, 0.1)',
                    textStyle: { color: '#374151', fontSize: 13 },
                    confine: false,
                    appendToBody: true,
                    enterable: true,
                    hideDelay: 100,
                    axisPointer: {
                        type: 'shadow',
                        shadowStyle: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    formatter: function (params) {
                        const dataIndex = params[0].dataIndex;
                        const count = params[0].value;
                        const label = intervalLabels[dataIndex];
                        let tooltipText = `<div style="padding: 8px;">
                            <div style="font-weight: 600; color: #1f2937; margin-bottom: 8px; font-size: 14px;">åŒºé—´: ${label}</div>
                            <div style="color: #6b7280; font-size: 13px;">å¤©æ•°: <span style="font-weight: 600; color: #1f2937;">${count}</span></div>`;

                        if (dataIndex === latestIntervalIndex) {
                            tooltipText += `<div style="color: #ef4444; font-size: 13px; margin-top: 4px;">
                                æœ€æ–°æ¢æ‰‹ç‡: <span style="font-weight: 600;">${latestTurnover}%</span><br/>
                                <span style="font-size: 12px;">(${latestDate})</span>
                            </div>`;
                        }

                        tooltipText += '</div>';
                        return tooltipText;
                    }
                },
                grid: {
                    left: '6%',
                    right: '6%',
                    bottom: '18%',
                    top: '22%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: intervalLabels,
                    axisLabel: {
                        fontSize: 11,
                        color: '#6b7280',
                        fontWeight: '500',
                        rotate: 45,
                        interval: 99, // æ¯100ä¸ªæ˜¾ç¤ºä¸€ä¸ªæ ‡ç­¾ï¼Œé¿å…è¿‡äºå¯†é›†
                        margin: 12
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#e5e7eb',
                            width: 1
                        }
                    },
                    axisTick: {
                        show: false
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'å¤©æ•°',
                    nameTextStyle: {
                        fontSize: 12,
                        color: '#6b7280',
                        fontWeight: '500'
                    },
                    axisLabel: {
                        fontSize: 12,
                        color: '#6b7280',
                        fontWeight: '500',
                        margin: 8
                    },
                    axisLine: {
                        show: false
                    },
                    axisTick: {
                        show: false
                    },
                    splitLine: {
                        lineStyle: {
                            color: '#f3f4f6',
                            width: 1,
                            type: 'dashed'
                        }
                    }
                },
                series: [{
                    name: 'å¤©æ•°',
                    type: 'bar',
                    data: data,
                    barWidth: '65%',
                    itemStyle: {
                        borderRadius: [4, 4, 0, 0],
                        shadowColor: 'rgba(0, 0, 0, 0.1)',
                        shadowBlur: 4,
                        shadowOffsetY: 2
                    },
                    emphasis: {
                        itemStyle: {
                            shadowColor: 'rgba(0, 0, 0, 0.2)',
                            shadowBlur: 8,
                            shadowOffsetY: 4
                        }
                    }
                }],
                legend: {
                    data: ['å¤©æ•°'],
                    bottom: 0,
                    textStyle: {
                        fontSize: 12,
                        color: '#6b7280',
                        fontWeight: '500'
                    }
                },
                animation: true,
                animationDuration: 1200,
                animationEasing: 'cubicOut',
                animationDelay: function (idx) {
                    return idx * 50;
                }
            };

            try {
                chart.setOption(option, true);

                // ç›‘å¬tooltipæ˜¾ç¤ºäº‹ä»¶ï¼Œç¡®ä¿z-indexæ­£ç¡®
                chart.on('showTip', function () {
                    setTimeout(() => {
                        const tooltips = document.querySelectorAll('.echarts-tooltip');
                        tooltips.forEach(tooltip => {
                            tooltip.style.zIndex = '9999';
                            tooltip.style.position = 'absolute';
                        });
                    }, 10);
                });

            } catch (error) {
                console.error('è®¾ç½®æ¢æ‰‹ç‡åˆ†å¸ƒå›¾è¡¨é€‰é¡¹å¤±è´¥:', error.message);
            }
        }

        // å…¨å±€å˜é‡å­˜å‚¨æ¸¯è‚¡è´¢åŠ¡åˆ†ææ•°æ®
        let globalHkAnalysisData = null;
        
        // å…¨å±€å˜é‡å­˜å‚¨Aè‚¡è´¢åŠ¡åˆ†ææ•°æ®
        let globalAShareAnalysisData = null;

        function displayHkAllCharts(debtData, assetData, profitDataData, profitRatioData, financialRatioData, cashFlowData) {
            // ä¿å­˜æ•°æ®åˆ°å…¨å±€å˜é‡
            globalHkAnalysisData = {
                debtData, assetData, profitDataData, profitRatioData, financialRatioData, cashFlowData
            };
            // æ£€æŸ¥æ•°æ® - æ¸¯è‚¡æ•°æ®æŒ‰æŠ¥å‘ŠæœŸç»„ç»‡ï¼Œå­—æ®µåä¸º yearlyRatios
            const debtRatios = debtData && debtData.yearlyRatios ? debtData.yearlyRatios : null;
            const assetRatios = assetData && assetData.yearlyRatios ? assetData.yearlyRatios : null;
            const profitDataRatios = profitDataData && profitDataData.yearlyRatios ? profitDataData.yearlyRatios : null;
            const profitRatioRatios = profitRatioData && profitRatioData.yearlyRatios ? profitRatioData.yearlyRatios : null;
            const financialRatioRatios = financialRatioData && financialRatioData.yearlyRatios ? financialRatioData.yearlyRatios : null;
            const cashFlowRatios = cashFlowData && cashFlowData.yearlyRatios ? cashFlowData.yearlyRatios : null;

            // åªè¦æœ‰ä»»ä¸€æ•°æ®å­˜åœ¨å°±ç»§ç»­æ˜¾ç¤º
            const hasAnyData = (debtRatios && Object.keys(debtRatios).length > 0) ||
                (assetRatios && Object.keys(assetRatios).length > 0) ||
                (profitDataRatios && Object.keys(profitDataRatios).length > 0) ||
                (profitRatioRatios && Object.keys(profitRatioRatios).length > 0) ||
                (financialRatioRatios && Object.keys(financialRatioRatios).length > 0) ||
                (cashFlowRatios && Object.keys(cashFlowRatios).length > 0);

            if (!hasAnyData) {
                showError('æœªæ‰¾åˆ°è¯¥æ¸¯è‚¡çš„è´¢åŠ¡æ•°æ®');
                document.getElementById('welcomeSection').style.display = 'block';
                return;
            }

            // éšè—æ¬¢è¿åŒºåŸŸ
            document.getElementById('welcomeSection').style.display = 'none';

            // åˆ›å»ºå›¾è¡¨å®¹å™¨ - ä¸¤åˆ—å¸ƒå±€
            const chartContainer = document.getElementById('chartContainer');
            let chartHtml = '';

            // ç¬¬ä¸€è¡Œï¼šè´Ÿå€ºç»“æ„ + èµ„äº§ç»“æ„
            if ((debtRatios && Object.keys(debtRatios).length > 0) ||
                (assetRatios && Object.keys(assetRatios).length > 0)) {
                chartHtml += `<div class="chart-row">`;

                if (debtRatios && Object.keys(debtRatios).length > 0) {
                    chartHtml += `<div class="chart-wrapper">
                        <div id="hkDebtChart" class="chart"></div>
                    </div>`;
                }

                if (assetRatios && Object.keys(assetRatios).length > 0) {
                    chartHtml += `<div class="chart-wrapper">
                        <div id="hkAssetChart" class="chart"></div>
                    </div>`;
                }

                chartHtml += `</div>`;
            }

            // ç¬¬äºŒè¡Œï¼šåˆ©æ¶¦è¡¨æ•°æ® + è´¢åŠ¡æ¯”ç‡
            if ((profitDataRatios && Object.keys(profitDataRatios).length > 0) ||
                (profitRatioRatios && Object.keys(profitRatioRatios).length > 0)) {
                chartHtml += `<div class="chart-row">`;

                if (profitDataRatios && Object.keys(profitDataRatios).length > 0) {
                    chartHtml += `<div class="chart-wrapper">
                        <div id="hkProfitDataChart" class="chart"></div>
                    </div>`;
                }

                if (profitRatioRatios && Object.keys(profitRatioRatios).length > 0) {
                    chartHtml += `<div class="chart-wrapper">
                        <div id="hkProfitRatioChart" class="chart"></div>
                    </div>`;
                }

                chartHtml += `</div>`;
            }

            // ç¬¬ä¸‰è¡Œï¼šè´¢åŠ¡æ¯”ç‡åˆ†æ + ç°é‡‘æµé‡è¡¨æ•°æ®
            if ((financialRatioRatios && Object.keys(financialRatioRatios).length > 0) ||
                (cashFlowRatios && Object.keys(cashFlowRatios).length > 0)) {
                chartHtml += `<div class="chart-row">`;

                if (financialRatioRatios && Object.keys(financialRatioRatios).length > 0) {
                    chartHtml += `<div class="chart-wrapper">
                        <div id="hkFinancialRatioChart" class="chart"></div>
                    </div>`;
                }

                if (cashFlowRatios && Object.keys(cashFlowRatios).length > 0) {
                    chartHtml += `<div class="chart-wrapper">
                        <div id="hkCashFlowChart" class="chart"></div>
                    </div>`;
                }

                chartHtml += `</div>`;
            }

            // ç¬¬å››è¡Œï¼šæ¸¯è‚¡æ¢æ‰‹ç‡åˆ†å¸ƒå›¾è¡¨
            chartHtml += `<div class="chart-row">`;
            chartHtml += `<div class="chart-wrapper">
                <div id="hkTurnoverDistributionChart" class="chart"></div>
            </div>`;
            chartHtml += `</div>`;

            chartContainer.innerHTML = chartHtml;
            chartContainer.style.display = 'block';

            // ç¡®ä¿å›¾è¡¨æ­£ç¡®æ¸²æŸ“
            setTimeout(() => {
                if (window.hkDebtChart && typeof window.hkDebtChart.resize === 'function') {
                    window.hkDebtChart.resize();
                }
                if (window.hkAssetChart && typeof window.hkAssetChart.resize === 'function') {
                    window.hkAssetChart.resize();
                }
                if (window.hkProfitDataChart && typeof window.hkProfitDataChart.resize === 'function') {
                    window.hkProfitDataChart.resize();
                }
                if (window.hkProfitRatioChart && typeof window.hkProfitRatioChart.resize === 'function') {
                    window.hkProfitRatioChart.resize();
                }
                if (window.hkFinancialRatioChart && typeof window.hkFinancialRatioChart.resize === 'function') {
                    window.hkFinancialRatioChart.resize();
                }
                if (window.hkCashFlowChart && typeof window.hkCashFlowChart.resize === 'function') {
                    window.hkCashFlowChart.resize();
                }
            }, 100);

            // æ¸²æŸ“æ¸¯è‚¡å›¾è¡¨
            // åˆå§‹æ˜¾ç¤ºæ—¶ï¼Œæ¸¯è‚¡æ€»æ˜¯æŒ‰æŠ¥å‘ŠæœŸæ˜¾ç¤ºï¼Œä¸ä¾èµ–switchçŠ¶æ€
            const useYearlyData = false;

            if (debtRatios && Object.keys(debtRatios).length > 0) {
                try {
                    displayHkDebtChart(debtData, useYearlyData);
                } catch (e) {
                    console.warn('æ¸¯è‚¡è´Ÿå€ºå›¾è¡¨æ˜¾ç¤ºå¤±è´¥:', e);
                }
            }

            if (assetRatios && Object.keys(assetRatios).length > 0) {
                try {
                    displayHkAssetChart(assetData, useYearlyData);
                } catch (e) {
                    console.warn('æ¸¯è‚¡èµ„äº§å›¾è¡¨æ˜¾ç¤ºå¤±è´¥:', e);
                }
            }

            if (profitDataRatios && Object.keys(profitDataRatios).length > 0) {
                try {
                    displayHkProfitDataChart(profitDataData, useYearlyData);
                } catch (e) {
                    console.warn('æ¸¯è‚¡åˆ©æ¶¦è¡¨æ•°æ®å›¾è¡¨æ˜¾ç¤ºå¤±è´¥:', e);
                }
            }

            if (profitRatioRatios && Object.keys(profitRatioRatios).length > 0) {
                try {
                    displayHkProfitRatioChart(profitRatioData, useYearlyData);
                } catch (e) {
                    console.warn('æ¸¯è‚¡åˆ©æ¶¦åˆ†æå›¾è¡¨æ˜¾ç¤ºå¤±è´¥:', e);
                }
            }

            if (financialRatioRatios && Object.keys(financialRatioRatios).length > 0) {
                try {
                    displayHkFinancialRatioChart(financialRatioData, useYearlyData);
                } catch (e) {
                    console.warn('æ¸¯è‚¡è´¢åŠ¡æ¯”ç‡åˆ†æå›¾è¡¨æ˜¾ç¤ºå¤±è´¥:', e);
                }
            }

            if (cashFlowRatios && Object.keys(cashFlowRatios).length > 0) {
                try {
                    displayHkCashFlowChart(cashFlowData, useYearlyData);
                } catch (e) {
                    console.warn('æ¸¯è‚¡ç°é‡‘æµé‡è¡¨å›¾è¡¨æ˜¾ç¤ºå¤±è´¥:', e);
                }
            }
        }

        // é€šç”¨æ•°æ®å¤„ç†å‡½æ•°
        function processChartData(yearlyRatios, chartTitle, isPercentage = true, allowZero = false, useYearlyData = false) {
            if (!yearlyRatios) {
                console.warn(`${chartTitle}æ•°æ®ä¸ºç©º`);
                return null;
            }

            let periods, formattedPeriods;
            let yearlyData = {}; // å°†yearlyDataå£°æ˜ç§»åˆ°å‡½æ•°é¡¶éƒ¨
            
            if (useYearlyData) {
                // æŒ‰å¹´åº¦æ¨¡å¼ï¼šæå–å¹´åº¦æ•°æ®
                Object.keys(yearlyRatios).forEach(period => {
                    const year = period.split('-')[0]; // æå–å¹´ä»½
                    if (!yearlyData[year]) {
                        yearlyData[year] = {};
                    }
                    // åˆå¹¶åŒä¸€å¹´ä»½çš„æ•°æ®ï¼ˆå–æœ€æ–°æŠ¥å‘ŠæœŸçš„æ•°æ®ï¼‰
                    Object.keys(yearlyRatios[period]).forEach(indicator => {
                        // å¦‚æœè¯¥æŒ‡æ ‡è¿˜æ²¡æœ‰å€¼ï¼Œæˆ–è€…å½“å‰æŠ¥å‘ŠæœŸæ¯”å·²æœ‰çš„æ›´æ–°ï¼Œåˆ™æ›´æ–°
                        if (!yearlyData[year][indicator] || period > Object.keys(yearlyRatios).filter(p => p.startsWith(year + '-')).sort().pop()) {
                            yearlyData[year][indicator] = yearlyRatios[period][indicator];
                        }
                    });
                });
                
                periods = Object.keys(yearlyData).sort();
                formattedPeriods = periods;
            } else {
                // æŒ‰æŠ¥å‘ŠæœŸæ¨¡å¼ï¼šä¿æŒåŸæœ‰é€»è¾‘
                periods = Object.keys(yearlyRatios).sort();
                
                // æ ¼å¼åŒ–æŠ¥å‘ŠæœŸæ˜¾ç¤ºï¼Œå»æ‰æ—¶é—´éƒ¨åˆ†ï¼Œåªä¿ç•™æ—¥æœŸ
                formattedPeriods = periods.map(period => {
                    if (period && period.includes(' ')) {
                        return period.split(' ')[0]; // åªå–æ—¥æœŸéƒ¨åˆ†ï¼Œå»æ‰æ—¶é—´
                    }
                    return period;
                });
            }
            
            const series = [];

            // è·å–æ‰€æœ‰æŒ‡æ ‡
            const indicators = new Set();
            if (useYearlyData) {
                // å¹´åº¦æ¨¡å¼ï¼šä»å¹´åº¦æ•°æ®ä¸­è·å–æŒ‡æ ‡
                periods.forEach(period => {
                    if (yearlyData[period]) {
                        Object.keys(yearlyData[period]).forEach(indicator => {
                            indicators.add(indicator);
                        });
                    }
                });
            } else {
                // æŠ¥å‘ŠæœŸæ¨¡å¼ï¼šä»åŸå§‹æ•°æ®ä¸­è·å–æŒ‡æ ‡
                periods.forEach(period => {
                    if (yearlyRatios[period]) {
                        Object.keys(yearlyRatios[period]).forEach(indicator => {
                            indicators.add(indicator);
                        });
                    }
                });
            }

            // ä¸ºæ¯ä¸ªæŒ‡æ ‡åˆ›å»ºæ•°æ®ç³»åˆ—
            const colors = [
                '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6',
                '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6366f1',
                '#14b8a6', '#f43f5e', '#a855f7', '#0ea5e9', '#22c55e',
                '#f97316', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b'
            ];
            // éšæœºæ‰“ä¹±é¢œè‰²æ•°ç»„ï¼Œç¡®ä¿é¢œè‰²åˆ†é…æ›´åŠ å¤šæ ·åŒ–
            const shuffledColors = [...colors].sort(() => Math.random() - 0.5);
            let colorIndex = 0;

            indicators.forEach(indicator => {
                const data = periods.map(period => {
                    let periodData;
                    if (useYearlyData) {
                        // å¹´åº¦æ¨¡å¼ï¼šç›´æ¥ä½¿ç”¨å¹´åº¦æ•°æ®
                        periodData = yearlyData[period];
                    } else {
                        periodData = yearlyRatios[period];
                    }
                    
                    if (!periodData || !periodData[indicator]) {
                        return null;
                    }
                    const value = periodData[indicator];

                    // å¤„ç†nullã€undefinedã€ç©ºå­—ç¬¦ä¸²å’Œæ— æ•ˆå€¼
                    if (value === null || value === undefined || value === '' || isNaN(value)) {
                        return null;
                    }

                    const numValue = parseFloat(value);
                    if (isNaN(numValue)) {
                        return null;
                    }

                    // å¦‚æœä¸å…è®¸0å€¼ä¸”å€¼ä¸º0ï¼Œè¿”å›null
                    if (!allowZero && numValue === 0) {
                        return null;
                    }

                    // å¦‚æœæ˜¯ç™¾åˆ†æ¯”æ•°æ®ï¼Œè½¬æ¢ä¸ºç™¾åˆ†æ¯”
                    return isPercentage ? numValue * 100 : numValue;
                });

                // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆæ•°æ®
                const validData = data.filter(val => val !== null);
                if (validData.length > 0) {
                    series.push({
                        name: indicator,
                        data: data,
                        color: shuffledColors[colorIndex % shuffledColors.length]
                    });
                    colorIndex++;
                }
            });

            if (series.length === 0) {
                console.warn(`${chartTitle}å›¾è¡¨æ²¡æœ‰æœ‰æ•ˆæ•°æ®`);
                return null;
            }

            return { periods: formattedPeriods, series };
        }

        function displayHkDebtChart(debtData, useYearlyData = false) {
            if (!debtData || !debtData.yearlyRatios) {
                console.warn('æ¸¯è‚¡è´Ÿå€ºæ•°æ®ä¸ºç©º');
                return;
            }

            const result = processChartData(debtData.yearlyRatios, 'æ¸¯è‚¡è´Ÿå€ºç»“æ„åˆ†æ', true, true, useYearlyData);
            if (result) {
                const title = useYearlyData ? 'æ¸¯è‚¡è´Ÿå€ºç»“æ„åˆ†æï¼ˆæŒ‰å¹´åº¦ï¼‰' : 'æ¸¯è‚¡è´Ÿå€ºç»“æ„åˆ†æ';
                createChart('hkDebtChart', title, result.periods, result.series, true);
            }
        }

        function displayHkAssetChart(assetData, useYearlyData = false) {
            if (!assetData || !assetData.yearlyRatios) {
                console.warn('æ¸¯è‚¡èµ„äº§æ•°æ®ä¸ºç©º');
                return;
            }

            const result = processChartData(assetData.yearlyRatios, 'æ¸¯è‚¡èµ„äº§ç»“æ„åˆ†æ', true, true, useYearlyData);
            if (result) {
                const title = useYearlyData ? 'æ¸¯è‚¡èµ„äº§ç»“æ„åˆ†æï¼ˆæŒ‰å¹´åº¦ï¼‰' : 'æ¸¯è‚¡èµ„äº§ç»“æ„åˆ†æ';
                createChart('hkAssetChart', title, result.periods, result.series, true);
            }
        }

        function displayHkProfitDataChart(profitDataData, useYearlyData = false) {
            if (!profitDataData || !profitDataData.yearlyRatios) {
                console.warn('æ¸¯è‚¡åˆ©æ¶¦è¡¨æ•°æ®ä¸ºç©º');
                return;
            }

            const result = processChartData(profitDataData.yearlyRatios, 'æ¸¯è‚¡åˆ©æ¶¦è¡¨æ•°æ®åˆ†æ', false, true, useYearlyData);
            if (result) {
                const title = useYearlyData ? 'æ¸¯è‚¡åˆ©æ¶¦è¡¨æ•°æ®åˆ†æï¼ˆæŒ‰å¹´åº¦ï¼‰' : 'æ¸¯è‚¡åˆ©æ¶¦è¡¨æ•°æ®åˆ†æ';
                createChart('hkProfitDataChart', title, result.periods, result.series, false);
            }
        }

        function displayHkProfitRatioChart(profitRatioData, useYearlyData = false) {
            if (!profitRatioData || !profitRatioData.yearlyRatios) {
                console.warn('æ¸¯è‚¡è´¢åŠ¡æ¯”ç‡æ•°æ®ä¸ºç©º');
                return;
            }

            const result = processChartData(profitRatioData.yearlyRatios, 'æ¸¯è‚¡åˆ©æ¶¦åˆ†æ', true, false, useYearlyData);
            if (result) {
                const title = useYearlyData ? 'æ¸¯è‚¡åˆ©æ¶¦åˆ†æï¼ˆæŒ‰å¹´åº¦ï¼‰' : 'æ¸¯è‚¡åˆ©æ¶¦åˆ†æ';
                createChart('hkProfitRatioChart', title, result.periods, result.series, true);
            }
        }

                function displayHkFinancialRatioChart(financialRatioData, useYearlyData = false) {
            if (!financialRatioData || !financialRatioData.yearlyRatios) {
                console.warn('æ¸¯è‚¡è´¢åŠ¡æ¯”ç‡åˆ†ææ•°æ®ä¸ºç©º');
                return;
            }

            const result = processChartData(financialRatioData.yearlyRatios, 'æ¸¯è‚¡è´¢åŠ¡æ¯”ç‡åˆ†æ', true, false, useYearlyData);
            if (result) {
                const title = useYearlyData ? 'æ¸¯è‚¡è´¢åŠ¡æ¯”ç‡åˆ†æï¼ˆæŒ‰å¹´åº¦ï¼‰' : 'æ¸¯è‚¡è´¢åŠ¡æ¯”ç‡åˆ†æ';
                createChart('hkFinancialRatioChart', title, result.periods, result.series, true);
            }
        }

        function displayHkCashFlowChart(cashFlowData, useYearlyData = false) {
            if (!cashFlowData || !cashFlowData.yearlyRatios) {
                console.warn('æ¸¯è‚¡ç°é‡‘æµé‡è¡¨æ•°æ®ä¸ºç©º');
                return;
            }

            const result = processChartData(cashFlowData.yearlyRatios, 'æ¸¯è‚¡ç°é‡‘æµé‡è¡¨åˆ†æ', false, true, useYearlyData);
            if (result) {
                const title = useYearlyData ? 'æ¸¯è‚¡ç°é‡‘æµé‡è¡¨åˆ†æï¼ˆæŒ‰å¹´åº¦ï¼‰' : 'æ¸¯è‚¡ç°é‡‘æµé‡è¡¨åˆ†æ';
                createChart('hkCashFlowChart', title, result.periods, result.series, false);
            }
        }

        // é‡æ–°ç»˜åˆ¶æ‰€æœ‰æ¸¯è‚¡å›¾è¡¨
        function redrawHkCharts(useYearlyData = false) {
            console.log('redrawHkChartsè¢«è°ƒç”¨ï¼Œå‚æ•°useYearlyData:', useYearlyData);
            
            if (!globalHkAnalysisData) {
                console.warn('æ²¡æœ‰å¯ç”¨çš„æ¸¯è‚¡åˆ†ææ•°æ®');
                return;
            }
            
            console.log('å¼€å§‹é‡æ–°ç»˜åˆ¶å›¾è¡¨ï¼Œæ•°æ®å­˜åœ¨');
            const { debtData, assetData, profitDataData, profitRatioData, financialRatioData, cashFlowData } = globalHkAnalysisData;
            
            // é‡æ–°ç»˜åˆ¶æ‰€æœ‰å›¾è¡¨
            if (debtData && debtData.yearlyRatios) {
                console.log('é‡æ–°ç»˜åˆ¶è´Ÿå€ºå›¾è¡¨');
                displayHkDebtChart(debtData, useYearlyData);
            }
            if (assetData && assetData.yearlyRatios) {
                console.log('é‡æ–°ç»˜åˆ¶èµ„äº§å›¾è¡¨');
                displayHkAssetChart(assetData, useYearlyData);
            }
            if (profitDataData && profitDataData.yearlyRatios) {
                console.log('é‡æ–°ç»˜åˆ¶åˆ©æ¶¦è¡¨æ•°æ®å›¾è¡¨');
                displayHkProfitDataChart(profitDataData, useYearlyData);
            }
            if (profitRatioData && profitRatioData.yearlyRatios) {
                console.log('é‡æ–°ç»˜åˆ¶åˆ©æ¶¦åˆ†æå›¾è¡¨');
                displayHkProfitRatioChart(profitRatioData, useYearlyData);
            }
            if (financialRatioData && financialRatioData.yearlyRatios) {
                console.log('é‡æ–°ç»˜åˆ¶è´¢åŠ¡æ¯”ç‡åˆ†æå›¾è¡¨');
                displayHkFinancialRatioChart(financialRatioData, useYearlyData);
            }
            if (cashFlowData && cashFlowData.yearlyRatios) {
                console.log('é‡æ–°ç»˜åˆ¶ç°é‡‘æµé‡è¡¨å›¾è¡¨');
                displayHkCashFlowChart(cashFlowData, useYearlyData);
            }
            
            console.log('æ‰€æœ‰å›¾è¡¨é‡æ–°ç»˜åˆ¶å®Œæˆ');
        }

        // é‡æ–°ç»˜åˆ¶æ‰€æœ‰Aè‚¡å›¾è¡¨
        function redrawAShareCharts(useYearlyData = false) {
            console.log('redrawAShareChartsè¢«è°ƒç”¨ï¼Œå‚æ•°useYearlyData:', useYearlyData);
            
            if (!globalAShareAnalysisData) {
                console.warn('æ²¡æœ‰å¯ç”¨çš„Aè‚¡åˆ†ææ•°æ®');
                return;
            }
            
            console.log('å¼€å§‹é‡æ–°ç»˜åˆ¶Aè‚¡å›¾è¡¨ï¼Œæ•°æ®å­˜åœ¨');
            const { debtData, assetData, profitDataData, profitRatioData, bloodDataData, bloodRatioData, financialRatioData, valuationData, turnoverDistributionData, shareholderData } = globalAShareAnalysisData;
            
            // é‡æ–°ç»˜åˆ¶æ‰€æœ‰å›¾è¡¨
            if (debtData && debtData.yearlyRatios) {
                console.log('é‡æ–°ç»˜åˆ¶Aè‚¡è´Ÿå€ºå›¾è¡¨');
                displayDebtChart(debtData, useYearlyData);
            }
            if (assetData && assetData.yearlyRatios) {
                console.log('é‡æ–°ç»˜åˆ¶Aè‚¡èµ„äº§å›¾è¡¨');
                displayAssetChart(assetData, useYearlyData);
            }
            if (profitDataData && profitDataData.yearlyRatios) {
                console.log('é‡æ–°ç»˜åˆ¶Aè‚¡åˆ©æ¶¦è¡¨æ•°æ®å›¾è¡¨');
                displayProfitDataChart(profitDataData, useYearlyData);
            }
            if (profitRatioData && profitRatioData.yearlyRatios) {
                console.log('é‡æ–°ç»˜åˆ¶Aè‚¡åˆ©æ¶¦åˆ†æå›¾è¡¨');
                displayProfitRatioChart(profitRatioData, useYearlyData);
            }
            if (bloodDataData && bloodDataData.yearlyDatas) {
                console.log('é‡æ–°ç»˜åˆ¶Aè‚¡é€ è¡€èƒ½åŠ›æ•°æ®å›¾è¡¨');
                displayBloodDataChart(bloodDataData, useYearlyData);
            }
            if (bloodRatioData && bloodRatioData.yearlyRatios) {
                console.log('é‡æ–°ç»˜åˆ¶Aè‚¡é€ è¡€èƒ½åŠ›æ¯”ç‡å›¾è¡¨');
                displayBloodRatioChart(bloodRatioData, useYearlyData);
            }
            if (financialRatioData && financialRatioData.yearlyRatios) {
                console.log('é‡æ–°ç»˜åˆ¶Aè‚¡è´¢åŠ¡æ¯”ç‡åˆ†æå›¾è¡¨');
                displayFinancialRatioChart(financialRatioData, useYearlyData);
            }
            
            console.log('æ‰€æœ‰Aè‚¡å›¾è¡¨é‡æ–°ç»˜åˆ¶å®Œæˆ');
        }

        // å±•ç¤ºæ¸¯è‚¡æ‰€æœ‰åŸºæœ¬ä¿¡æ¯å­—æ®µ
        function displayHkBasicInfo(info, stockCode) {
            // è®¾ç½®å…¨å±€è‚¡ç¥¨ä»£ç ï¼Œä¾›è‡ªé€‰è‚¡åŠŸèƒ½ä½¿ç”¨
            window.currentStockCode = stockCode;
            
            const section = document.getElementById('stockInfoSection');
            let html = `<div class="stock-info-header">
                <h2>${info.comcnname || ''}ï¼ˆ${info.comenname || ''}ï¼‰</h2>
                <div class="stock-actions">
                    <button id="addToWatchlistBtn" class="action-btn watch-btn" onclick="addToWatchlist(1)">
                        åŠ è§‚å¯Ÿ
                    </button>
                    <button id="addToPortfolioBtn" class="action-btn portfolio-btn" onclick="addToWatchlist(2)">
                        è®¾ä¸ºæŒä»“è‚¡
                    </button>
                </div>
            </div>`;
            
            // ç¡®ä¿æ¸¯è‚¡é¡µé¢æœ‰stockInfoTitleå…ƒç´ ï¼Œç”¨äºè‡ªé€‰è‚¡åŠŸèƒ½
            let stockInfoTitle = document.getElementById('stockInfoTitle');
            if (!stockInfoTitle) {
                // å¦‚æœå…ƒç´ ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ª
                stockInfoTitle = document.createElement('h2');
                stockInfoTitle.id = 'stockInfoTitle';
                stockInfoTitle.style.display = 'none'; // éšè—è¿™ä¸ªå…ƒç´ ï¼Œå› ä¸ºæ¸¯è‚¡é¡µé¢ä¸éœ€è¦æ˜¾ç¤ºå®ƒ
                section.appendChild(stockInfoTitle);
            }
            stockInfoTitle.textContent = `${info.comcnname || info.comenname || stockCode} - æ¸¯è‚¡åŸºæœ¬ä¿¡æ¯`;
            html += '<div class="stock-info-grid">';

            // åŸºæœ¬ä¿¡æ¯ç»„ - æ•´åˆå…¬å¸åç§°å’Œè¡Œä¸š
            if (info.comcnname || info.comenname || info.industry) {
                html += `<div class="stock-info-item basic-info full-width">`;
                if (info.comcnname) html += `<div class="info-label">å…¬å¸åç§°</div><div class="info-value">${info.comcnname}${info.comenname ? ` / ${info.comenname}` : ''}</div>`;
                if (info.industry) html += `<div class="info-label">æ‰€å±è¡Œä¸š</div><div class="info-value">${info.industry}</div>`;
                html += '</div>';
            }
            
            // å…¬å¸æ³¨å†Œå·
            if (info.comunic) html += `<div class="stock-info-item basic-info"><div class="info-label">å…¬å¸æ³¨å†Œå·</div><div class="info-value">${info.comunic}</div></div>`;
            
            // ç®¡ç†å±‚ä¿¡æ¯ç»„ - æ•´åˆæ³•å®šä»£è¡¨äººå’Œè‘£äº‹é•¿
            if (info.legalRepresentative || info.chairman) {
                html += `<div class="stock-info-item shares-info">`;
                if (info.legalRepresentative) html += `<div class="info-label">æ³•å®šä»£è¡¨äºº</div><div class="info-value">${info.legalRepresentative}</div>`;
                if (info.chairman && info.chairman !== info.legalRepresentative) html += `<div class="info-label">è‘£äº‹é•¿</div><div class="info-value">${info.chairman}</div>`;
                html += '</div>';
            }
            
            // æˆç«‹æ—¥æœŸå’Œæ³¨å†Œèµ„æœ¬
            if (info.incdate || info.registeredCapital) {
                html += `<div class="stock-info-item shares-info">`;
                if (info.incdate) html += `<div class="info-label">æˆç«‹æ—¥æœŸ</div><div class="info-value">${formatDateFromTimestamp(info.incdate)}</div>`;
                if (info.registeredCapital) html += `<div class="info-label">æ³¨å†Œèµ„æœ¬</div><div class="info-value">${info.registeredCapital}</div>`;
                html += '</div>';
            }
            
            // åœ°å€ä¿¡æ¯ç»„ - æ•´åˆæ³¨å†Œåœ°å€å’ŒåŠå…¬åœ°å€
            if (info.rgiofc || info.hofclctmbu) {
                html += `<div class="stock-info-item market-info full-width">`;
                if (info.rgiofc) html += `<div class="info-label">æ³¨å†Œåœ°å€</div><div class="info-value">${info.rgiofc}</div>`;
                if (info.hofclctmbu) html += `<div class="info-label">åŠå…¬åœ°å€</div><div class="info-value">${info.hofclctmbu}</div>`;
                html += '</div>';
            }
            
            // è”ç³»ä¿¡æ¯ç»„ - æ•´åˆè”ç³»æ–¹å¼
            if (info.website || info.email || info.phone) {
                html += `<div class="stock-info-item other-info full-width">`;
                if (info.website) html += `<div class="info-label">å…¬å¸ç½‘å€</div><div class="info-value"><a href="http://${info.website}" target="_blank" style="color:#3b82f6;">${info.website}</a></div>`;
                if (info.email) html += `<div class="info-label">å…¬å¸é‚®ç®±</div><div class="info-value"><a href="mailto:${info.email}" style="color:#3b82f6;">${info.email}</a></div>`;
                if (info.phone) html += `<div class="info-label">è”ç³»ç”µè¯</div><div class="info-value">${info.phone}</div>`;
                html += '</div>';
            }
            
            // ä¸šåŠ¡ä¿¡æ¯ç»„ - æ•´åˆä¸»è¥ä¸šåŠ¡å’Œç»è¥èŒƒå›´
            if (info.mbu || info.businessScope) {
                html += `<div class="stock-info-item other-info full-width">`;
                if (info.mbu) html += `<div class="info-label">ä¸»è¥ä¸šåŠ¡</div><div class="info-value">${info.mbu}</div>`;
                if (info.businessScope) html += `<div class="info-label">ç»è¥èŒƒå›´</div><div class="info-value">${info.businessScope}</div>`;
                html += '</div>';
            }

            html += '</div>';
            
            // å…¬å¸ç®€ä»‹å•ç‹¬ä¸€è¡Œï¼Œå†…å®¹è¾ƒé•¿
            if (info.comintr) {
                html += '<div class="company-intro-section">';
                html += '<div class="company-intro-header"><h3>å…¬å¸ç®€ä»‹</h3></div>';
                html += '<div class="company-intro-content">' + info.comintr + '</div>';
                html += '</div>';
            }
            
            section.innerHTML = html;
            section.style.display = 'block';
            
            // ä¸ºæ¸¯è‚¡è®¾ç½®è‚¡ç¥¨ä»£ç å’Œåç§°ï¼Œä½¿æŒ‰é’®èƒ½æ­£å¸¸å·¥ä½œ
            // æ¸¯è‚¡ä»£ç é€šå¸¸æ˜¯5ä½æ•°å­—
            const stockCodeElement = document.getElementById('stockCode');
            if (stockCodeElement) {
                stockCodeElement.textContent = stockCode || '-';
            }
            
            // æ¸¯è‚¡åç§°ä½¿ç”¨ä¸­æ–‡åç§°
            const stockNameElement = document.getElementById('stockName');
            if (stockNameElement) {
                stockNameElement.textContent = info.comcnname || info.comenname || '-';
            }
            
            // ç¡®ä¿å…ƒç´ å†…å®¹è®¾ç½®å®Œæˆåå†æ£€æŸ¥è‡ªé€‰è‚¡çŠ¶æ€
            setTimeout(() => {
                checkWatchlistStatus(stockCode);
            }, 100);
        }

        function formatDateFromTimestamp(ts) {
            if (!ts) return '-';
            try {
                const d = new Date(Number(ts));
                if (isNaN(d.getTime())) return '-';
                return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
            } catch { return '-'; }
        }

        function displayShareholderChart(shareholderData) {
            if (!shareholderData || !shareholderData.shareholderData || shareholderData.shareholderData.length === 0) {
                console.warn('è‚¡ä¸œæˆ·æ•°æ•°æ®ä¸ºç©º');
                return;
            }

            const data = shareholderData.shareholderData;

            // æŒ‰ç»Ÿè®¡æ—¥æœŸæ’åº
            data.sort((a, b) => {
                const dateA = new Date(a.statisticalDate);
                const dateB = new Date(b.statisticalDate);
                return dateA - dateB;
            });

            // æå–æ—¥æœŸå’Œè‚¡ä¸œæˆ·æ•°æ•°æ®ï¼Œä½¿ç”¨ä¸å…¶ä»–å›¾è¡¨ä¸€è‡´çš„æ—¶é—´æ ¼å¼
            const dates = data.map(item => {
                const date = new Date(item.statisticalDate);
                return date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0') + '-' + String(date.getDate()).padStart(2, '0');
            });

            const shareholderCounts = data.map(item => {
                const count = parseFloat(item.shareholderCount);
                return isNaN(count) ? null : count;
            });

            const series = [
                {
                    name: 'è‚¡ä¸œæˆ·æ•°',
                    data: shareholderCounts,
                    color: '#1e40af',
                    type: 'bar',
                    barWidth: '60%',
                    itemStyle: {
                        borderRadius: [4, 4, 0, 0]
                    }
                }
            ];

            const chartDom = document.getElementById('shareholderChart');
            if (!chartDom) {
                console.error('æ‰¾ä¸åˆ°è‚¡ä¸œæˆ·æ•°å›¾è¡¨å®¹å™¨');
                return;
            }

            const chart = echarts.init(chartDom);
            window.shareholderChart = chart;

            const option = {
                title: {
                    text: `${data[0].symbol} è‚¡ä¸œæˆ·æ•°è¶‹åŠ¿`,
                    left: 'center',
                    textStyle: {
                        fontSize: 16,
                        fontWeight: 'bold',
                        color: '#1a202c'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function (params) {
                        const data = params[0];
                        if (data.value === null || data.value === undefined) {
                            return `${data.axisValue}<br/>${data.seriesName}: æš‚æ— æ•°æ®`;
                        }
                        return `${data.axisValue}<br/>${data.seriesName}: ${data.value.toLocaleString()} æˆ·`;
                    },
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    borderColor: '#e2e8f0',
                    borderWidth: 1,
                    textStyle: {
                        color: '#1a202c'
                    }
                },
                grid: {
                    left: '10%',
                    right: '10%',
                    bottom: '15%',
                    top: '20%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    axisLabel: {
                        rotate: 45,
                        fontSize: 12,
                        color: '#4a5568'
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#e2e8f0'
                        }
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'è‚¡ä¸œæˆ·æ•°',
                    nameTextStyle: {
                        color: '#4a5568',
                        fontSize: 12
                    },
                    axisLabel: {
                        formatter: function (value) {
                            if (value >= 10000) {
                                return (value / 10000).toFixed(1) + 'ä¸‡';
                            }
                            return value.toLocaleString();
                        },
                        fontSize: 12,
                        color: '#4a5568'
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#e2e8f0'
                        }
                    },
                    splitLine: {
                        lineStyle: {
                            color: '#f7fafc',
                            type: 'dashed'
                        }
                    }
                },
                series: series
            };

            try {
                chart.setOption(option);
            } catch (error) {
                console.error('è®¾ç½®è‚¡ä¸œæˆ·æ•°å›¾è¡¨é€‰é¡¹å¤±è´¥:', error.message);
            }
        }

        /**
         * æ˜¾ç¤ºæ¸¯è‚¡æ¢æ‰‹ç‡åˆ†å¸ƒå›¾è¡¨
         */
        function displayHkTurnoverDistributionChart(turnoverDistributionData) {
            if (!turnoverDistributionData || !turnoverDistributionData.success) {
                console.warn('æ¸¯è‚¡æ¢æ‰‹ç‡åˆ†å¸ƒæ•°æ®ä¸ºç©º');
                return;
            }

            const intervalCounts = turnoverDistributionData.intervalCounts;
            const intervalLabels = turnoverDistributionData.intervalLabels;
            const latestIntervalIndex = turnoverDistributionData.latestIntervalIndex;
            const latestTurnover = turnoverDistributionData.latestTurnover;
            const latestDate = turnoverDistributionData.latestDate;
            const stock = turnoverDistributionData.stock;

            // å‡†å¤‡æŸ±çŠ¶å›¾æ•°æ®
            const data = [];
            for (let i = 0; i < intervalCounts.length; i++) {
                const item = {
                    value: intervalCounts[i],
                    itemStyle: {
                        color: i === latestIntervalIndex ? '#e74c3c' : '#3498db' // æœ€æ–°åŒºé—´æ ‡è®°ä¸ºçº¢è‰²
                    }
                };
                data.push(item);
            }

            // åˆ›å»ºæŸ±çŠ¶å›¾
            const chart = echarts.init(document.getElementById('hkTurnoverDistributionChart'));
            window.hkTurnoverDistributionChart = chart;

            const option = {
                title: {
                    text: `${stock} æ¸¯è‚¡æ¢æ‰‹ç‡åˆ†å¸ƒåˆ†æ`,
                    left: 'center',
                    top: 16,
                    textStyle: {
                        fontSize: 18,
                        fontWeight: '600',
                        color: '#1f2937',
                        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(255, 255, 255, 0.98)',
                    borderColor: '#e5e7eb',
                    borderWidth: 1,
                    borderRadius: 8,
                    boxShadow: '0 10px 25px rgba(0, 0, 0, 0.1)',
                    textStyle: { color: '#374151', fontSize: 13 },
                    confine: false,
                    appendToBody: true,
                    enterable: true,
                    hideDelay: 100,
                    axisPointer: {
                        type: 'shadow',
                        shadowStyle: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    formatter: function (params) {
                        const dataIndex = params[0].dataIndex;
                        const count = params[0].value;
                        const label = intervalLabels[dataIndex];
                        let tooltipText = `<div style="padding: 8px;">
                            <div style="font-weight: 600; color: #1f2937; margin-bottom: 8px; font-size: 14px;">åŒºé—´: ${label}</div>
                            <div style="color: #6b7280; font-size: 13px;">å¤©æ•°: <span style="font-weight: 600; color: #1f2937;">${count}</span></div>`;

                        if (dataIndex === latestIntervalIndex) {
                            tooltipText += `<div style="color: #ef4444; font-size: 13px; margin-top: 4px;">
                                æœ€æ–°æ¢æ‰‹ç‡: <span style="font-weight: 600;">${latestTurnover}</span><br/>
                                <span style="font-size: 12px;">(${latestDate})</span>
                            </div>`;
                        }

                        tooltipText += '</div>';
                        return tooltipText;
                    }
                },
                grid: {
                    left: '6%',
                    right: '6%',
                    bottom: '18%',
                    top: '22%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: intervalLabels,
                    axisLabel: {
                        fontSize: 11,
                        color: '#6b7280',
                        fontWeight: '500',
                        rotate: 45,
                        interval: 99, // æ¯100ä¸ªæ˜¾ç¤ºä¸€ä¸ªæ ‡ç­¾ï¼Œé¿å…è¿‡äºå¯†é›†
                        margin: 12
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#e5e7eb',
                            width: 1
                        }
                    },
                    axisTick: {
                        show: false
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'å¤©æ•°',
                    nameTextStyle: {
                        color: '#6b7280',
                        fontSize: 12,
                        fontWeight: '500'
                    },
                    axisLabel: {
                        fontSize: 12,
                        color: '#6b7280',
                        fontWeight: '500'
                    },
                    axisLine: {
                        show: false
                    },
                    axisTick: {
                        show: false
                    },
                    splitLine: {
                        lineStyle: {
                            color: '#f3f4f6',
                            type: 'dashed'
                        }
                    }
                },
                series: [{
                    name: 'å¤©æ•°',
                    type: 'bar',
                    data: data,
                    barWidth: '60%',
                    itemStyle: {
                        borderRadius: [4, 4, 0, 0]
                    }
                }]
            };

            try {
                chart.setOption(option);
            } catch (error) {
                console.error('è®¾ç½®æ¸¯è‚¡æ¢æ‰‹ç‡åˆ†å¸ƒå›¾è¡¨é€‰é¡¹å¤±è´¥:', error.message);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–switchäº‹ä»¶ç›‘å¬å™¨');
            
            // åˆå§‹åŒ–switchåˆ‡æ¢äº‹ä»¶
            const analysisSwitch = document.getElementById('analysisSwitch');
            console.log('æ‰¾åˆ°switchå…ƒç´ :', analysisSwitch);
            
            if (analysisSwitch) {
                analysisSwitch.addEventListener('change', function() {
                    const useYearlyData = this.checked;
                    console.log('Switchåˆ‡æ¢äº‹ä»¶è§¦å‘! å½“å‰çŠ¶æ€:', useYearlyData ? 'æŒ‰å¹´åº¦' : 'æŒ‰æŠ¥å‘ŠæœŸ');
                    console.log('globalHkAnalysisDataå­˜åœ¨:', !!globalHkAnalysisData);
                    
                    // é‡æ–°ç»˜åˆ¶æ¸¯è‚¡å›¾è¡¨ï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰
                    if (globalHkAnalysisData) {
                        console.log('å¼€å§‹é‡æ–°ç»˜åˆ¶æ¸¯è‚¡å›¾è¡¨...');
                        redrawHkCharts(useYearlyData);
                        console.log('æ¸¯è‚¡å›¾è¡¨é‡æ–°ç»˜åˆ¶å®Œæˆ');
                    } else {
                        console.log('æ²¡æœ‰å¯ç”¨çš„æ¸¯è‚¡åˆ†ææ•°æ®');
                    }
                    
                    // é‡æ–°ç»˜åˆ¶Aè‚¡å›¾è¡¨ï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰
                    if (globalAShareAnalysisData) {
                        console.log('å¼€å§‹é‡æ–°ç»˜åˆ¶Aè‚¡å›¾è¡¨...');
                        redrawAShareCharts(useYearlyData);
                        console.log('Aè‚¡å›¾è¡¨é‡æ–°ç»˜åˆ¶å®Œæˆ');
                    } else {
                        console.log('æ²¡æœ‰å¯ç”¨çš„Aè‚¡åˆ†ææ•°æ®');
                    }
                });
                
                console.log('Switchäº‹ä»¶ç›‘å¬å™¨è®¾ç½®æˆåŠŸ');
            } else {
                console.error('æœªæ‰¾åˆ°analysisSwitchå…ƒç´ ');
            }
        });

        // è‡ªé€‰è‚¡ç›¸å…³å‡½æ•°
        function showWatchlist() {
            // éšè—æ¬¢è¿åŒºåŸŸ
            const welcomeSection = document.getElementById('welcomeSection');
            if (welcomeSection) {
                welcomeSection.style.display = 'none';
            }
            
            // æ˜¾ç¤ºè‡ªé€‰è‚¡åŒºåŸŸ
            const watchlistSection = document.getElementById('watchlistSection');
            watchlistSection.style.display = 'block';
            
            // åŠ è½½è‡ªé€‰è‚¡æ•°æ®
            loadWatchlistData();
        }

        function hideWatchlist() {
            // éšè—è‡ªé€‰è‚¡åŒºåŸŸ
            const watchlistSection = document.getElementById('watchlistSection');
            watchlistSection.style.display = 'none';
            
            // æ˜¾ç¤ºæ¬¢è¿åŒºåŸŸ
            const welcomeSection = document.getElementById('welcomeSection');
            if (welcomeSection) {
                welcomeSection.style.display = 'block';
            }
        }

        function loadWatchlistData() {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const tableBody = document.getElementById('watchlistTableBody');
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #6b7280;">æ­£åœ¨åŠ è½½è‡ªé€‰è‚¡æ•°æ®...</td></tr>';
            
            // è°ƒç”¨åç«¯APIè·å–è‡ªé€‰è‚¡æ•°æ®
            fetch('/api/watchlist/all')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && data.data) {
                        displayWatchlistData(data.data);
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #ef4444;">åŠ è½½å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯') + '</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½è‡ªé€‰è‚¡æ•°æ®å¤±è´¥:', error);
                    tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: 40px; color: #ef4444;">åŠ è½½å¤±è´¥: ' + error.message + '</td></tr>';
                });
        }

        function displayWatchlistData(watchlistData) {
            const tableBody = document.getElementById('watchlistTableBody');
            
            if (!watchlistData || watchlistData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #6b7280;">æš‚æ— è‡ªé€‰è‚¡æ•°æ®</td></tr>';
                return;
            }
            
            let html = '';
            watchlistData.forEach(stock => {
                const stockTypeText = getStockTypeText(stock.stockType);
                const stockTypeClass = `stock-type-${stock.stockType}`;
                
                html += `
                    <tr>
                        <td>${stock.stockCode}</td>
                        <td>${stock.stockName}</td>
                        <td><span class="stock-type-badge ${stockTypeClass}">${stockTypeText}</span></td>
                        <td>${formatNumber(stock.peTtm)}</td>
                        <td>${formatNumber(stock.roe)}%</td>
                        <td>${formatNumber(stock.profitQuality)}</td>
                        <td>${formatNumber(stock.assetsQuality)}</td>
                        <td>${formatNumber(stock.peScore)}</td>
                        <td>
                            <button class="analyze-btn" onclick="analyzeStockFromWatchlist('${stock.stockCode}', '${stock.stockName}')">
                                å¼€å§‹åˆ†æ
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        function getStockTypeText(stockType) {
            switch (stockType) {
                case 0: return 'è§‚å¯Ÿè‚¡';
                case 1: return 'è§‚å¯Ÿè‚¡';
                case 2: return 'æŒä»“è‚¡';
                default: return 'æœªçŸ¥';
            }
            return 'æœªçŸ¥';
        }

        function formatNumber(value) {
            if (value === null || value === undefined) return '-';
            if (typeof value === 'number') {
                if (value === 0) return '0';
                if (Math.abs(value) < 0.01) return value.toFixed(4);
                if (Math.abs(value) < 0.1) return value.toFixed(3);
                if (Math.abs(value) < 1) return value.toFixed(2);
                if (Math.abs(value) < 10) return value.toFixed(2);
                if (Math.abs(value) < 100) return value.toFixed(1);
                return value.toFixed(0);
            }
            return value;
        }

        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '-';
            try {
                const date = new Date(dateTimeStr);
                if (isNaN(date.getTime())) return dateTimeStr;
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return dateTimeStr;
            }
        }

        // ä»è‡ªé€‰è‚¡è¡¨æ ¼ä¸­å¯åŠ¨è‚¡ç¥¨åˆ†æ
        function analyzeStockFromWatchlist(stockCode, stockName) {
            console.log('ä»è‡ªé€‰è‚¡å¯åŠ¨åˆ†æ:', stockCode, stockName);
            
            // éšè—è‡ªé€‰è‚¡åŒºåŸŸ
            hideWatchlist();
            
            // è®¾ç½®è‚¡ç¥¨ä»£ç åˆ°è¾“å…¥æ¡†
            const stockSymbolInput = document.getElementById('stockSymbol');
            if (stockSymbolInput) {
                stockSymbolInput.value = stockCode;
            }
            
            // è®¾ç½®å…¨å±€è‚¡ç¥¨ä»£ç 
            window.currentStockCode = stockCode;
            
            // æ ¹æ®è‚¡ç¥¨ä»£ç åˆ¤æ–­æ˜¯Aè‚¡è¿˜æ˜¯æ¸¯è‚¡ï¼Œç„¶åè°ƒç”¨ç›¸åº”çš„åˆ†æå‡½æ•°
            if (stockCode.startsWith('00') || stockCode.startsWith('30') || stockCode.startsWith('60')) {
                // Aè‚¡
                console.log('å¯åŠ¨Aè‚¡åˆ†æ:', stockCode);
                analyzeAShareStock(stockCode, stockName);
            } else if (stockCode.startsWith('0') && stockCode.length === 5) {
                // æ¸¯è‚¡
                console.log('å¯åŠ¨æ¸¯è‚¡åˆ†æ:', stockCode);
                analyzeHkStock(stockCode, stockName);
            } else {
                console.error('æ— æ³•è¯†åˆ«è‚¡ç¥¨ç±»å‹:', stockCode);
                alert('æ— æ³•è¯†åˆ«è‚¡ç¥¨ç±»å‹ï¼Œè¯·æ£€æŸ¥è‚¡ç¥¨ä»£ç ');
            }
        }
    </script>
</body>

</html>